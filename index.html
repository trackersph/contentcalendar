<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlan - Content Calendar</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Icons (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: {
                    sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                },
                extend: {
                    colors: {
                        iosBlue: '#007AFF',
                        iosGray: '#F2F2F7',
                        iosDarkGray: '#1C1C1E',
                        // Softer Colors for Settings
                        softRed: '#fef2f2', 
                        softOrange: '#fff7ed', 
                        softYellow: '#fffdf0', 
                        softGreen: '#f0fdf4', 
                        softBlue: '#eff6ff', 
                        softIndigo: '#eef2ff',
                        softPurple: '#f5f3ff',
                        softPink: '#fdf2f8',
                    },
                    borderRadius: {
                        '3xl': '1.5rem',
                        '4xl': '2rem',
                    },
                    boxShadow: {
                        'ios': '0 4px 20px rgba(0,0,0,0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-font-smoothing: antialiased; }
        
        /* Custom Scrollbar - Minimalist */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 99px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        ::-webkit-scrollbar-track { background: transparent; }
        
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .droppable-hover {
            transform: scale(0.98);
            border-radius: 1rem;
            background-color: rgba(0, 122, 255, 0.1);
            border: 2px dashed #007AFF;
        }

        /* Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #007AFF;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #374151;
        }

        /* Notebook Styles */
        .notebook-overlay {
            position: fixed;
            bottom: 100px; /* Moved up to accommodate new FAB row */
            right: 24px;
            width: 380px; 
            height: 500px; 
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 50;
            transform-origin: bottom right;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }
        .notebook-overlay.closed {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        /* Adjusted existing notebook fab position */
        .notebook-fab {
            position: fixed;
            bottom: 24px;
            right: 100px; /* Moved left */
            width: 56px;
            height: 56px;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 50;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .notebook-fab:hover {
            transform: scale(1.05);
        }
        
        /* New Create FAB Styles */
        .create-fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 60;
            display: flex;
            flex-direction: column;
            align-items: end;
            gap: 12px;
        }
        .create-fab-main {
            width: 64px;
            height: 64px;
            border-radius: 32px;
            background-color: #007AFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,122,255,0.4);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .create-fab-main:hover { transform: scale(1.05); }
        .create-fab-main.open { transform: rotate(45deg); background-color: #1C1C1E; }
        .dark .create-fab-main.open { background-color: #3a3a3c; }

        .create-fab-option {
            display: flex;
            align-items: center;
            gap: 12px;
            transform-origin: right bottom;
            animation: fab-slide-in 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fab-slide-in {
            from { opacity: 0; transform: translateY(10px) scale(0.8); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .notebook-editor {
            flex: 1;
            overflow-y: auto;
            outline: none;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
        }
        .notebook-editor ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        .notebook-editor ol {
            list-style-type: decimal;
            padding-left: 20px;
        }
        .notebook-editor blockquote {
            border-left: 3px solid #007AFF;
            padding-left: 10px;
            color: gray;
        }
        .mention-chip {
            color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            display: inline-block;
            margin: 0 2px;
            font-size: 0.9em;
        }
        .mention-chip:hover {
            background: rgba(0, 122, 255, 0.2);
            text-decoration: underline;
        }
        /* Checkbox Style in Notebook */
        .todo-checkbox {
            cursor: pointer;
            user-select: none;
            margin-right: 4px;
            display: inline-block;
            color: #007AFF;
            font-size: 1.1em;
            vertical-align: middle;
        }
        .todo-checkbox:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        /* Toolbar Button Style */
        .toolbar-btn {
            padding: 4px;
            border-radius: 4px;
            color: #4b5563;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark .toolbar-btn { color: #d1d5db; }
        .toolbar-btn:hover { background: rgba(0,0,0,0.05); }
        .dark .toolbar-btn:hover { background: rgba(255,255,255,0.1); }

        /* Bulk Select Toolbar */
        .bulk-toolbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            border-radius: 99px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .dark .bulk-toolbar {
            background: rgba(255, 255, 255, 0.8);
            color: black;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .bulk-toolbar-button {
            padding: 8px 12px;
            border-radius: 99px;
            font-weight: 600;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bulk-toolbar-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .dark .bulk-toolbar-button:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
    </style>
</head>
<body class="bg-[#F2F2F7] dark:bg-black text-slate-900 dark:text-white transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3Pi_BB5D_uDq9yNYraGyCxg_JukNp66k",
            authDomain: "studio-2523816271-96710.firebaseapp.com",
            projectId: "studio-2523816271-96710",
            storageBucket: "studio-2523816271-96710.firebasestorage.app",
            messagingSenderId: "79405504947",
            appId: "1:79405504947:web:69b9ac42b50098cec713c6"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Defaults ---
        const LONG_PRESS_DURATION = 750; // New longer press duration for multi-select

        const FULL_EMOJI_LIST = {
            "Popular": ["ðŸ”¥", "âœ¨", "ðŸš€", "ðŸ’¡", "ðŸ“…", "âœ…", "âŒ", "â¤ï¸", "ðŸ‘", "ðŸŽ‰", "ðŸ‘€", "ðŸ“¸"],
            "Faces": ["ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ˜‚", "ðŸ¤£", "ðŸ˜Š", "ðŸ˜‡", "ðŸ™‚", "ðŸ™ƒ", "ðŸ˜‰", "ðŸ˜Œ", "ðŸ˜", "ðŸ¥°", "ðŸ˜˜", "ðŸ˜—", "ðŸ¤ª", "ðŸ¤¨", "ðŸ§", "ðŸ¤“", "ðŸ˜Ž", "ðŸ¤©", "ðŸ¥³", "ðŸ˜", "ðŸ˜’", "ðŸ˜ž", "ðŸ˜”", "ðŸ˜Ÿ", "ðŸ˜•", "ðŸ™", "â˜¹ï¸", "ðŸ˜£", "ðŸ˜–", "ðŸ˜«", "ðŸ˜©", "ðŸ¥º", "ðŸ˜¢", "ðŸ˜­", "ðŸ˜¤", "ðŸ˜ ", "ðŸ˜¡", "ðŸ¤¬", "ðŸ¤¯", "ðŸ˜³", "ðŸ¥µ", "ðŸ¥¶", "ðŸ˜±", "ðŸ˜¨", "ðŸ¤—", "ðŸ¤”", "ðŸ¤­", "ðŸ¤«", "ðŸ¤¥", "ðŸ˜¶", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¬", "ðŸ™„", "ðŸ˜¯", "ðŸ˜¦", "ðŸ˜§", "ðŸ˜®", "ðŸ˜²", "ðŸ¥±", "ðŸ˜´", "ðŸ¤¤", "ðŸ˜ª", "ðŸ˜µ", "ðŸ¤", "ðŸ¥´", "ðŸ¤¢", "ðŸ¤®", "ðŸ¤§", "ðŸ˜·", "ðŸ¤’", "ðŸ¤•", "ðŸ¤‘", "ðŸ¤ ", "ðŸ˜ˆ", "ðŸ‘¿", "ðŸ‘¹", "ðŸ‘º", "ðŸ¤¡", "ðŸ’©", "ðŸ‘»", "ðŸ’€", "â˜ ï¸", "ðŸ‘½", "ðŸ‘¾", "ðŸ¤–", "ðŸŽƒ"],
            "Gestures": ["ðŸ‘‹", "ðŸ¤š", "ðŸ–", "âœ‹", "ðŸ––", "ðŸ‘Œ", "ðŸ¤Œ", "ðŸ¤", "âœŒï¸", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤˜", "ðŸ¤™", "ðŸ‘ˆ", "ðŸ‘‰", "ðŸ‘†", "ðŸ–•", "ðŸ‘‡", "â˜ï¸", "ðŸ‘", "ðŸ‘Ž", "âœŠ", "ðŸ‘Š", "ðŸ¤›", "ðŸ¤œ", "ðŸ‘", "ðŸ™Œ", "ðŸ‘", "ðŸ¤²", "ðŸ¤", "ðŸ™", "âœï¸", "ðŸ’…", "ðŸ¤³", "ðŸ’ª", "ðŸ¦¾", "ðŸ¦¿", "ðŸ¦µ", "ðŸ¦¶", "ðŸ‘‚", "ðŸ¦»", "ðŸ‘ƒ", "ðŸ§ ", "ðŸ«€", "ðŸ«", "ðŸ¦·", "ðŸ¦´", "ðŸ‘€", "ðŸ‘", "ðŸ‘…", "ðŸ‘„", "ðŸ’‹"],
            "Objects": ["ðŸ’»", "ðŸ“±", "ðŸ“·", "ðŸŽ¥", "ðŸ“ž", "â˜Žï¸", "â°", "â³", "ðŸ’¡", "ðŸ”¦", "ðŸ•¯", "ðŸ”Ž", "ðŸ“¦", "ðŸ“«", "âœï¸", "ðŸ“", "ðŸ’¼", "ðŸ“", "ðŸ“…", "ðŸ“Œ", "ðŸ“Ž", "âœ‚ï¸", "ðŸ”’", "ðŸ”‘", "ðŸ”¨", "ðŸ§°", "ðŸ”«", "ðŸ¹", "ðŸ›¡", "ðŸ”§", "ðŸª›", "ðŸ’Š", "ðŸ’‰", "ðŸ§¬", "ðŸ”­", "ðŸ”¬", "ðŸ“¡", "ðŸ›", "ðŸ‘“", "ðŸ•¶", "ðŸ¥½", "ðŸ¥¼", "ðŸ¦º", "ðŸ‘”", "ðŸ‘•", "ðŸ‘–", "ðŸ§£", "ðŸ§¤", "ðŸ§¥", "ðŸ§¦", "ðŸ‘—", "ðŸ‘˜", "ðŸ¥»", "ðŸ©±", "ðŸ©²", "ðŸ©³", "ðŸ‘™", "ðŸ‘š", "ðŸ‘›", "ðŸ‘œ", "ðŸ‘", "ðŸŽ’", "ðŸ‘ž", "ðŸ‘Ÿ", "ðŸ¥¾", "ðŸ¥¿", "ðŸ‘ ", "ðŸ‘¡", "ðŸ©°", "ðŸ‘¢", "ðŸ‘‘", "ðŸ‘’", "ðŸŽ©", "ðŸŽ“", "ðŸ§¢", "â›‘", "ðŸ“¿", "ðŸ’„", "ðŸ’", "ðŸ’Ž"],
            "Symbols": ["â¤ï¸", "ðŸ§¡", "ðŸ’›", "ðŸ’š", "ðŸ’™", "ðŸ’œ", "ðŸ–¤", "ðŸ¤", "ðŸ¤Ž", "ðŸ’”", "â£ï¸", "ðŸ’•", "ðŸ’ž", "ðŸ’“", "ðŸ’—", "ðŸ’–", "ðŸ’˜", "ðŸ’", "ðŸ’Ÿ", "â˜®ï¸", "âœï¸", "â˜ªï¸", "ðŸ•‰", "â˜¸ï¸", "âœ¡ï¸", "ðŸ”¯", "ðŸ•Ž", "â˜¯ï¸", "â˜¦ï¸", "ðŸ›", "â›Ž", "â™ˆï¸", "â™‰ï¸", "â™Šï¸", "â™‹ï¸", "â™Œï¸", "â™ï¸", "â™Žï¸", "â™ï¸", "â™ï¸", "â™‘ï¸", "â™’ï¸", "â™“ï¸", "ðŸ†”", "âš›ï¸", "ðŸ‰‘", "â˜¢ï¸", "â˜£ï¸", "ðŸ“´", "ðŸ“³", "ðŸˆ¶", "ðŸˆšï¸", "ðŸˆ¸", "ðŸˆº", "ðŸˆ·ï¸", "âœ´ï¸", "ðŸ†š", "ðŸ’®", "ðŸ‰", "ãŠ™ï¸", "ãŠ—ï¸", "ðŸˆ´", "ðŸˆµ", "ðŸˆ¹", "ðŸˆ¹", "ðŸˆ²", "ðŸ…°ï¸", "ðŸ…±ï¸", "ðŸ†Ž", "ðŸ†‘", "ðŸ…¾ï¸", "ðŸ†˜", "âŒ", "â­•ï¸", "ðŸ›‘", "â›”ï¸", "ðŸ“›", "ðŸš«", "ðŸ’¯", "ðŸ’¢", "â™¨ï¸", "ðŸš·", "ðŸš¯", "ðŸš³", "ðŸš±", "ðŸ”ž", "ðŸ“µ", "ðŸš­", "â—ï¸", "â•", "â“", "â”", "â€¼ï¸", "â‰ï¸", "ðŸ”…", "ðŸ”†", "ã€½ï¸", "âš ï¸", "ðŸš¸", "ðŸ”±", "âšœï¸", "ðŸ”°", "â™»ï¸", "âœ…", "ðŸˆ¯ï¸", "ðŸ’¹", "â‡ï¸", "âœ³ï¸", "âŽ", "ðŸŒ", "ðŸ’ ", "â“‚ï¸", "ðŸŒ€", "ðŸ’¤", "ðŸ§", "ðŸš¾", "â™¿ï¸", "ðŸ…¿ï¸", "ðŸ›—", "ðŸˆ", "ðŸˆ‚ï¸", "ðŸ›‚", "ðŸ›ƒ", "ðŸ›„", "ðŸ›…", "ðŸš¹", "ðŸšº", "ðŸš¼", "ðŸš»", "ðŸš®", "ðŸŽ¦", "ðŸ“¶", "ðŸˆ", "ðŸ”£", "â„¹ï¸", "ðŸ”¤", "ðŸ”¡", "ðŸ” ", "ðŸ†–", "ðŸ†—", "ðŸ†™", "ðŸ†’", "ðŸ†•", "ðŸ†“", "0ï¸âƒ£", "1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ðŸ”Ÿ", "ðŸ”¢", "#ï¸âƒ£", "*ï¸âƒ£", "âï¸", "â–¶ï¸", "â¸", "â¯", "â¹", "âº", "â­", "â®", "â©", "âª", "â«", "â¬", "â—€ï¸", "ðŸ”¼", "ðŸ”½", "âž¡ï¸", "â¬…ï¸", "â¬†ï¸", "â¬‡ï¸", "â†—ï¸", "â†˜ï¸", "â†™ï¸", "â†–ï¸", "â†•ï¸", "â†”ï¸", "â†ªï¸", "â†©ï¸", "â¤´ï¸", "â¤µï¸", "ðŸ”€", "ðŸ”", "ðŸ”‚", "ðŸ”„", "ðŸ”ƒ", "ðŸŽµ", "ðŸŽ¶", "âž•", "âž–", "âž—", "âœ–ï¸", "â™¾", "ðŸ’²", "ðŸ’±", "â„¢ï¸", "Â©ï¸", "Â®ï¸", "ðŸ‘â€ðŸ—¨", "ðŸ”š", "ðŸ”™", "ðŸ”›", "ðŸ”", "ðŸ”œ", "ã€°ï¸", "âž°", "âž¿", "âœ”ï¸", "â˜‘ï¸", "ðŸ”˜", "ðŸ”´", "ðŸŸ ", "ðŸŸ¡", "ðŸŸ¢", "ðŸ”µ", "ðŸŸ£", "âš«ï¸", "âšªï¸", "ðŸŸ¤", "ðŸ”º", "ðŸ”»", "ðŸ”¸", "ðŸ”¹", "ðŸ”¶", "ðŸ”·", "ðŸ”³", "ðŸ”²", "â–ªï¸", "â–«ï¸", "â—¾ï¸", "â—½ï¸", "â—¼ï¸", "â—»ï¸", "ðŸŸ¥", "ðŸŸ§", "ðŸŸ¨", "ðŸŸ©", "ðŸŸ¦", "ðŸŸª", "â¬›ï¸", "â¬œï¸", "ðŸŸ«", "ðŸ”ˆ", "ðŸ”‡", "ðŸ”‰", "ðŸ”Š", "ðŸ””", "ðŸ”•", "ðŸ“£", "ðŸ“¢", "ðŸ’¬", "ðŸ’­", "ðŸ—¯", "â™ ï¸", "â™£ï¸", "â™¥ï¸", "â™¦ï¸", "ðŸƒ", "ðŸŽ´", "ðŸ€„ï¸", "ðŸ•", "ðŸ•‘", "ðŸ•’", "ðŸ•“", "ðŸ•”", "ðŸ••", "ðŸ•–", "ðŸ•—", "ðŸ•˜", "ðŸ•™", "ðŸ•š", "ðŸ•›", "ðŸ•œ", "ðŸ•", "ðŸ•ž", "ðŸ•Ÿ", "ðŸ• ", "ðŸ•¡", "ðŸ•¢", "ðŸ•£", "ðŸ•¤", "ðŸ•¥", "ðŸ•¦", "ðŸ•§"]
        };
        
        const INITIAL_PLATFORMS = {
            ig: { id: 'ig', label: 'Instagram', color: 'bg-pink-500', icon: 'ph-instagram-logo' },
            fb: { id: 'fb', label: 'Facebook', color: 'bg-blue-600', icon: 'ph-facebook-logo' },
            tt: { id: 'tt', label: 'TikTok', color: 'bg-black dark:bg-gray-700', icon: 'ph-tiktok-logo' },
            yt: { id: 'yt', label: 'YouTube', color: 'bg-red-600', icon: 'ph-youtube-logo' },
            bg: { id: 'bg', label: 'Blog', color: 'bg-emerald-500', icon: 'ph-article' },
            li: { id: 'li', label: 'LinkedIn', color: 'bg-blue-700', icon: 'ph-linkedin-logo' }
        };

        const INITIAL_STATUSES = {
            idea: { id: 'idea', label: 'Idea', color: 'bg-gray-200 text-gray-700 dark:bg-gray-800 dark:text-gray-300', icon: 'ph-lightbulb' },
            drafting: { id: 'drafting', label: 'Drafting', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300', icon: 'ph-pencil-simple' },
            scheduled: { id: 'scheduled', label: 'Scheduled', color: 'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300', icon: 'ph-calendar-check' },
            posted: { id: 'posted', label: 'Posted', color: 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300', icon: 'ph-check-circle' }
        };

        const INITIAL_PILLARS = {
            educational: { id: 'educational', label: 'Educational', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300', icon: 'ph-graduation-cap' },
            entertaining: { id: 'entertaining', label: 'Entertaining', color: 'bg-pink-100 text-pink-700 dark:bg-pink-900/40 dark:text-pink-300', icon: 'ph-sparkle' },
            inspirational: { id: 'inspirational', label: 'Inspirational', color: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300', icon: 'ph-cloud-arrow-up' },
            promotional: { id: 'promotional', label: 'Promotional', color: 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300', icon: 'ph-megaphone' },
            bts: { id: 'bts', label: 'Behind the Scenes', color: 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300', icon: 'ph-eye' },
            ugc: { id: 'ugc', label: 'User Generated', color: 'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300', icon: 'ph-users' },
            other: { id: 'other', label: 'Other', color: 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200', icon: 'ph-hash' }
        };

        const INITIAL_TOPICS = {
            general: { id: 'general', label: 'General', color: 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300', icon: 'ph-chats' },
            news: { id: 'news', label: 'Industry News', color: 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300', icon: 'ph-newspaper' },
            tutorial: { id: 'tutorial', label: 'Tutorials', color: 'bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-300', icon: 'ph-monitor' },
            product: { id: 'product', label: 'Product Update', color: 'bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-300', icon: 'ph-package' }
        };

        const MEDIA_TYPES = ["Image", "Video", "Carousel", "Reel/Short", "Story", "Text/Link"];
        const APPROVAL_STATUSES = ["Draft", "Pending Approval", "Changes Requested", "Approved"];
        const RECURRENCE_TYPES = [
            { id: 'none', label: 'Does not repeat' },
            { id: 'daily', label: 'Daily' },
            { id: 'weekly', label: 'Weekly' },
            { id: 'biweekly', label: 'Bi-Weekly' },
            { id: 'monthly', label: 'Monthly' },
            { id: 'quarterly', label: 'Quarterly' },
            { id: 'yearly', label: 'Yearly' },
            { id: 'every_x_days', label: 'Every X Days' }
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // Date formatting helper
        const formatDate = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };


        // --- Components ---
        const NotebookOverlay = ({ items, onOpenItem }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            // Use state for storage only
            const [noteHtml, setNoteHtml] = React.useState(() => localStorage.getItem('omniplan_notebook_html') || '');
            // Ref for initial content to decouple DOM updates from React state
            const initialHtmlRef = React.useRef(noteHtml);
            
            const [mentionQuery, setMentionQuery] = React.useState(null);
            
            const overlayRef = React.useRef(null);
            const fabRef = React.useRef(null);
            const editorRef = React.useRef(null);

            // Debounced Save
            React.useEffect(() => {
                const handler = setTimeout(() => {
                    localStorage.setItem('omniplan_notebook_html', noteHtml);
                }, 500);
                return () => clearTimeout(handler);
            }, [noteHtml]);

            // Auto Minimize Click Outside
            React.useEffect(() => {
                function handleClickOutside(event) {
                    if (isOpen && 
                        overlayRef.current && !overlayRef.current.contains(event.target) &&
                        fabRef.current && !fabRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [isOpen]);

            const handleInput = (e) => {
                // Update state for storage, but don't force re-render via props
                setNoteHtml(e.target.innerHTML);
                
                // Simple mention check using selection
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const textNode = range.startContainer;
                    if (textNode.nodeType === Node.TEXT_NODE) {
                        const text = textNode.textContent;
                        const caretPos = range.startOffset;
                        const lastAt = text.lastIndexOf('@', caretPos - 1);
                        
                        if (lastAt !== -1 && lastAt < caretPos) {
                            const query = text.substring(lastAt + 1, caretPos);
                            if (!query.includes(' ') && !query.includes('\n') && !query.includes('&nbsp;')) {
                                setMentionQuery(query.toLowerCase());
                                return;
                            }
                        }
                    }
                }
                setMentionQuery(null);
            };

            const execCmd = (cmd, value = null) => {
                document.execCommand(cmd, false, value);
                if (editorRef.current) {
                    editorRef.current.focus();
                    // Sync change manually after command
                    setNoteHtml(editorRef.current.innerHTML); 
                }
            };

            const insertMention = (item) => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const textNode = range.startContainer;
                    const text = textNode.textContent;
                    const caretPos = range.startOffset;
                    const lastAt = text.lastIndexOf('@', caretPos - 1);
                    
                    if (lastAt !== -1) {
                        const newRange = document.createRange();
                        newRange.setStart(textNode, lastAt);
                        newRange.setEnd(textNode, caretPos);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                        const html = `<span class="mention-chip" contentEditable="false" data-id="${item.id}">@${item.title}</span>&nbsp;`;
                        document.execCommand('insertHTML', false, html);
                        setNoteHtml(editorRef.current.innerHTML);
                    }
                }
                setMentionQuery(null);
            };

            const handleEditorClick = (e) => {
                if (e.target.classList.contains('mention-chip')) {
                    const id = e.target.dataset.id;
                    const item = items.find(i => i.id === id);
                    if (item && onOpenItem) {
                        onOpenItem(item);
                        setIsOpen(false);
                    }
                }

                // Checkbox Click
                if (e.target.classList.contains('todo-checkbox')) {
                    const isChecked = e.target.innerHTML.includes('â˜‘') || e.target.innerHTML.includes('9745');
                    e.target.innerHTML = isChecked ? '&#9744;' : '&#9745;'; 
                    setNoteHtml(editorRef.current.innerHTML);
                }
            };

            const filteredItems = mentionQuery !== null 
                ? items.filter(i => (i.title || 'Untitled').toLowerCase().includes(mentionQuery)).slice(0, 5) 
                : [];

            return (
                <>
                    <div 
                        ref={overlayRef}
                        className={`notebook-overlay bg-white dark:bg-[#1C1C1E] border border-gray-100 dark:border-gray-700 ${!isOpen ? 'closed' : ''}`}
                    >
                        {/* Header & Toolbar */}
                        <div className="border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 rounded-t-[24px]">
                            <div className="px-4 py-3 flex justify-between items-center">
                                <h3 className="font-bold text-sm dark:text-white flex items-center gap-2">
                                    <i className="ph ph-notebook text-iosBlue"></i> Quick Notes
                                </h3>
                                <button onClick={() => setIsOpen(false)} className="text-gray-400 hover:text-gray-600"><i className="ph ph-x"></i></button>
                            </div>
                            
                            {/* Extended Toolbar */}
                            <div className="px-2 py-2 flex flex-wrap gap-1 border-t border-gray-100 dark:border-gray-700">
                                <button onClick={() => execCmd('bold')} className="toolbar-btn" title="Bold"><i className="ph ph-text-b"></i></button>
                                <button onClick={() => execCmd('italic')} className="toolbar-btn" title="Italic"><i className="ph ph-text-italic"></i></button>
                                <button onClick={() => execCmd('underline')} className="toolbar-btn" title="Underline"><i className="ph ph-text-underline"></i></button>
                                <button onClick={() => execCmd('strikeThrough')} className="toolbar-btn" title="Strike"><i className="ph ph-text-strikethrough"></i></button>
                                <div className="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                <button onClick={() => execCmd('insertUnorderedList')} className="toolbar-btn" title="Bullet List"><i className="ph ph-list-bullets"></i></button>
                                <button onClick={() => execCmd('insertOrderedList')} className="toolbar-btn" title="Number List"><i className="ph ph-list-numbers"></i></button>
                                <button onClick={() => execCmd('insertHTML', '<span class="todo-checkbox" contentEditable="false">&#9744;</span>&nbsp;')} className="toolbar-btn" title="Checkbox"><i className="ph ph-check-square"></i></button>
                                <div className="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                <button onClick={() => execCmd('formatBlock', 'H1')} className="toolbar-btn font-bold text-xs" title="Heading 1">H1</button>
                                <button onClick={() => execCmd('formatBlock', 'H2')} className="toolbar-btn font-bold text-xs" title="Heading 2">H2</button>
                                <div className="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                <button onClick={() => execCmd('justifyLeft')} className="toolbar-btn" title="Left"><i className="ph ph-text-align-left"></i></button>
                                <button onClick={() => execCmd('justifyCenter')} className="toolbar-btn" title="Center"><i className="ph ph-text-align-center"></i></button>
                                <div className="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                <div className="relative toolbar-btn overflow-hidden w-6 h-6">
                                    <i className="ph ph-palette z-10 pointer-events-none"></i>
                                    <input type="color" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onChange={(e) => execCmd('foreColor', e.target.value)} title="Text Color" />
                                </div>
                                <div className="relative toolbar-btn overflow-hidden w-6 h-6">
                                    <i className="ph ph-highlighter z-10 pointer-events-none"></i>
                                    <input type="color" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onChange={(e) => execCmd('hiliteColor', e.target.value)} title="Highlight Color" />
                                </div>
                            </div>
                        </div>
                        
                        {/* Editor */}
                        <div className="flex-1 relative overflow-hidden flex flex-col">
                            <div 
                                ref={editorRef}
                                className="notebook-editor dark:text-gray-200"
                                contentEditable={true}
                                onInput={handleInput}
                                onClick={handleEditorClick}
                                dangerouslySetInnerHTML={{__html: initialHtmlRef.current}} 
                                suppressContentEditableWarning={true}
                            />
                            {!noteHtml && <div className="absolute top-4 left-4 text-gray-400 pointer-events-none text-sm">Type @ to link content...</div>}
                            
                            {/* Dropdown */}
                            {mentionQuery !== null && filteredItems.length > 0 && (
                                <div className="absolute bottom-2 left-2 right-2 bg-white dark:bg-gray-800 shadow-xl rounded-xl border border-gray-100 dark:border-gray-700 overflow-hidden z-20 animate-fade-in-up">
                                    <div className="px-3 py-2 text-[10px] font-bold text-gray-400 uppercase bg-gray-50 dark:bg-gray-900">Link Content</div>
                                    {filteredItems.map(item => (
                                        <button 
                                            key={item.id}
                                            onClick={() => insertMention(item)}
                                            className="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 truncate flex items-center gap-2"
                                        >
                                            <span className="w-2 h-2 rounded-full bg-iosBlue"></span>
                                            {item.title || 'Untitled'}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <button 
                        ref={fabRef}
                        onClick={() => setIsOpen(!isOpen)} 
                        className="notebook-fab bg-black dark:bg-white text-white dark:text-black"
                    >
                        {isOpen ? <i className="ph ph-caret-down text-xl"></i> : <i className="ph ph-pencil-simple text-xl"></i>}
                    </button>
                </>
            );
        };

        const CreateFab = ({ onOpenContent, onOpenEvent }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const ref = React.useRef(null);

            React.useEffect(() => {
                function handleClickOutside(event) {
                    if (isOpen && ref.current && !ref.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [isOpen]);

            return (
                <div ref={ref} className="create-fab-container">
                    {isOpen && (
                        <>
                            <div className="create-fab-option">
                                <span className="bg-white dark:bg-gray-800 dark:text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow-lg border border-gray-100 dark:border-gray-700">New Event</span>
                                <button onClick={() => { onOpenEvent(); setIsOpen(false); }} className="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center shadow-lg hover:scale-110 transition">
                                    <i className="ph ph-flag text-xl"></i>
                                </button>
                            </div>
                            <div className="create-fab-option">
                                <span className="bg-white dark:bg-gray-800 dark:text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow-lg border border-gray-100 dark:border-gray-700">New Content</span>
                                <button onClick={() => { onOpenContent(); setIsOpen(false); }} className="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shadow-lg hover:scale-110 transition">
                                    <i className="ph ph-pencil-simple text-xl"></i>
                                </button>
                            </div>
                        </>
                    )}
                    <button 
                        className={`create-fab-main ${isOpen ? 'open' : ''}`} 
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <i className="ph ph-plus text-3xl"></i>
                    </button>
                </div>
            )
        };

        const ReminderModal = ({ items, onClose }) => {
            if (items.length === 0) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in-up">
                    <div className="bg-white dark:bg-[#1C1C1E] rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center relative overflow-hidden border border-gray-100 dark:border-gray-700">
                        <div className="w-16 h-16 bg-iosBlue/10 text-iosBlue rounded-full flex items-center justify-center mx-auto mb-4">
                            <i className="ph ph-bell-ringing text-3xl"></i>
                        </div>
                        <h3 className="text-xl font-bold mb-2 dark:text-white">Today's Schedule</h3>
                        <p className="text-gray-500 text-sm mb-6">You have {items.length} post{items.length > 1 ? 's' : ''} scheduled for today!</p>
                        
                        <div className="space-y-3 mb-6 max-h-48 overflow-y-auto text-left">
                            {items.map(item => (
                                <div key={item.id} className="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                                    <div className={`w-2 h-8 rounded-full ${item.progress >= 100 ? 'bg-green-500' : 'bg-iosBlue'}`}></div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-semibold text-sm truncate dark:text-white">{item.title}</h4>
                                        <p className="text-xs text-gray-400">
                                            {Array.isArray(item.platform) ? `${item.platform.length} platforms` : item.platform}
                                        </p>
                                    </div>
                                    {item.status === 'posted' && <i className="ph ph-check-circle text-green-500"></i>}
                                </div>
                            ))}
                        </div>
                        
                        <button onClick={onClose} className="w-full bg-iosBlue text-white py-3 rounded-xl font-bold hover:scale-[1.02] transition shadow-lg shadow-blue-500/20">Let's get to work</button>
                    </div>
                </div>
            )
        };

        const AuthScreen = ({ onLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [isRegistering, setIsRegistering] = React.useState(false);
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    let userCred;
                    if (isRegistering) {
                        userCred = await auth.createUserWithEmailAndPassword(email, password);
                    } else {
                        userCred = await auth.signInWithEmailAndPassword(email, password);
                    }
                    onLogin(userCred.user);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-[#F2F2F7] p-6">
                    <div className="bg-white rounded-[2rem] shadow-ios p-8 w-full max-w-sm text-center">
                        <div className="mb-8">
                            <div className="w-16 h-16 bg-iosBlue rounded-2xl mx-auto flex items-center justify-center text-white text-3xl mb-4 shadow-lg shadow-blue-500/30">
                                <i className="ph ph-calendar-check"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-gray-900 tracking-tight">Welcome</h1>
                            <p className="text-gray-500 mt-2 text-sm">Your offline-first creative studio.</p>
                        </div>
                        {error && <div className="bg-red-50 text-red-500 p-3 rounded-xl mb-4 text-xs font-medium">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="email" placeholder="Email" required 
                                className="w-full bg-gray-100 p-4 rounded-xl text-sm outline-none focus:ring-2 focus:ring-iosBlue/50 transition-all"
                                value={email} onChange={e => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" required 
                                className="w-full bg-gray-100 p-4 rounded-xl text-sm outline-none focus:ring-2 focus:ring-iosBlue/50 transition-all"
                                value={password} onChange={e => setPassword(e.target.value)} />
                            
                            <button disabled={loading} className="w-full bg-iosBlue text-white p-4 rounded-xl font-semibold shadow-lg shadow-blue-500/20 active:scale-95 transition-all">
                                {loading ? 'Please wait...' : (isRegistering ? 'Sign Up' : 'Log In')}
                            </button>
                        </form>
                        <div className="mt-6 flex flex-col gap-3">
                            <button onClick={() => setIsRegistering(!isRegistering)} className="text-sm text-iosBlue font-medium">
                                {isRegistering ? 'Have an account? Log In' : 'Create Account'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportsView = ({ items, pillars, topics }) => {
            const today = new Date();
            const last30 = new Date();
            last30.setDate(today.getDate() - 30);
            
            const [startDate, setStartDate] = React.useState(last30.toISOString().split('T')[0]);
            const [endDate, setEndDate] = React.useState(today.toISOString().split('T')[0]);

            const filteredItems = React.useMemo(() => {
                return items.filter(item => {
                    if (!item.date) return false;
                    return item.date >= startDate && item.date <= endDate;
                });
            }, [items, startDate, endDate]);

            const totalItems = filteredItems.length;

            const stats = React.useMemo(() => {
                const s = { posted: 0, approved: 0, pending: 0, changes: 0, draft: 0 };
                filteredItems.forEach(item => {
                    if (item.status === 'posted') s.posted++;
                    if (item.approvalStatus === 'Approved') s.approved++;
                    if (item.approvalStatus === 'Pending Approval') s.pending++;
                    if (item.approvalStatus === 'Changes Requested') s.changes++;
                    if (item.approvalStatus === 'Draft') s.draft++;
                });
                return s;
            }, [filteredItems]);

            const pillarStats = React.useMemo(() => {
                const counts = {};
                filteredItems.forEach(item => {
                    if (item.contentPillar) {
                        counts[item.contentPillar] = (counts[item.contentPillar] || 0) + 1;
                    }
                });
                return Object.entries(counts)
                    .map(([id, count]) => ({ id, label: pillars[id]?.label || id, count, pct: Math.round((count / totalItems) * 100) }))
                    .sort((a,b) => b.count - a.count);
            }, [filteredItems, pillars, totalItems]);

            const topicStats = React.useMemo(() => {
                const counts = {};
                filteredItems.forEach(item => {
                    if (item.topic) {
                        counts[item.topic] = (counts[item.topic] || 0) + 1;
                    }
                });
                return Object.entries(counts)
                    .map(([id, count]) => ({ id, label: topics[id]?.label || id, count, pct: Math.round((count / totalItems) * 100) }))
                    .sort((a,b) => b.count - a.count);
            }, [filteredItems, topics, totalItems]);

            const hashtagStats = React.useMemo(() => {
                const counts = {};
                filteredItems.forEach(item => {
                    if (item.hashtags) {
                        const tags = item.hashtags.match(/#[\w-]+/g) || [];
                        tags.forEach(tag => { counts[tag] = (counts[tag] || 0) + 1; });
                    }
                });
                return Object.entries(counts)
                    .map(([tag, count]) => ({ tag, count }))
                    .sort((a,b) => b.count - a.count)
                    .slice(0, 8);
            }, [filteredItems]);

            const StatCard = ({ label, count, color, icon }) => (
                <div className="bg-white dark:bg-[#1C1C1E] p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">{label}</p>
                        <div className="flex items-baseline gap-2">
                            <span className="text-3xl font-bold dark:text-white">{count}</span>
                            <span className="text-xs font-medium text-gray-400">({totalItems > 0 ? Math.round((count/totalItems)*100) : 0}%)</span>
                        </div>
                    </div>
                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${color}`}>
                        <i className={`ph ${icon}`}></i>
                    </div>
                </div>
            );

            return (
                <div className="flex-1 overflow-y-auto p-6 bg-[#F2F2F7] dark:bg-black">
                    <div className="bg-white dark:bg-[#1C1C1E] p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-800 mb-6 flex flex-wrap items-center gap-4 justify-between">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-iosBlue/10 rounded-full flex items-center justify-center text-iosBlue"><i className="ph ph-chart-pie-slice text-xl"></i></div>
                            <h2 className="text-xl font-bold dark:text-white">Performance Reports</h2>
                        </div>
                        <div className="flex items-center gap-3 bg-gray-50 dark:bg-gray-800 p-2 rounded-2xl">
                            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent text-sm font-semibold text-gray-600 dark:text-gray-300 outline-none px-2" />
                            <span className="text-gray-400">-</span>
                            <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent text-sm font-semibold text-gray-600 dark:text-gray-300 outline-none px-2" />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                        <StatCard label="Posted" count={stats.posted} color="bg-green-100 text-green-600 dark:bg-green-900/40" icon="ph-check-circle" />
                        <StatCard label="Approved" count={stats.approved} color="bg-blue-100 text-blue-600 dark:bg-blue-900/40" icon="ph-thumbs-up" />
                        <StatCard label="Pending" count={stats.pending} color="bg-orange-100 text-orange-600 dark:bg-orange-900/40" icon="ph-hourglass" />
                        <StatCard label="Changes" count={stats.changes} color="bg-red-100 text-red-600 dark:bg-red-900/40" icon="ph-warning-circle" />
                        <StatCard label="Drafts" count={stats.draft} color="bg-gray-100 text-gray-600 dark:bg-gray-800" icon="ph-pencil-simple" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div className="bg-white dark:bg-[#1C1C1E] p-6 rounded-[2rem] shadow-sm border border-gray-100 dark:border-gray-800">
                            <h3 className="text-lg font-bold mb-6 dark:text-white">Content Pillars</h3>
                            <div className="space-y-4">
                                {pillarStats.map(p => (
                                    <div key={p.id}>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="font-semibold text-gray-700 dark:text-gray-300">{p.label}</span>
                                            <span className="text-gray-400">{p.count} ({p.pct}%)</span>
                                        </div>
                                        <div className="w-full bg-gray-100 dark:bg-gray-800 h-2 rounded-full overflow-hidden">
                                            <div className="bg-iosBlue h-full rounded-full" style={{width: `${p.pct}%`}}></div>
                                        </div>
                                    </div>
                                ))}
                                {pillarStats.length === 0 && <p className="text-gray-400 text-sm text-center py-4">No data in range</p>}
                            </div>
                        </div>

                        <div className="bg-white dark:bg-[#1C1C1E] p-6 rounded-[2rem] shadow-sm border border-gray-100 dark:border-gray-800">
                            <h3 className="text-lg font-bold mb-6 dark:text-white">Topics</h3>
                            <div className="space-y-4">
                                {topicStats.map(t => (
                                    <div key={t.id}>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="font-semibold text-gray-700 dark:text-gray-300">{t.label}</span>
                                            <span className="text-gray-400">{t.count} ({t.pct}%)</span>
                                        </div>
                                        <div className="w-full bg-gray-100 dark:bg-gray-800 h-2 rounded-full overflow-hidden">
                                            <div className="bg-purple-500 h-full rounded-full" style={{width: `${t.pct}%`}}></div>
                                        </div>
                                    </div>
                                ))}
                                {topicStats.length === 0 && <p className="text-gray-400 text-sm text-center py-4">No data in range</p>}
                            </div>
                        </div>

                        <div className="bg-white dark:bg-[#1C1C1E] p-6 rounded-[2rem] shadow-sm border border-gray-100 dark:border-gray-800">
                            <h3 className="text-lg font-bold mb-6 dark:text-white">Top Hashtags</h3>
                            <div className="flex flex-wrap gap-2">
                                {hashtagStats.map((h, i) => (
                                    <div key={h.tag} className="flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <span className={`font-bold ${i < 3 ? 'text-iosBlue' : 'text-gray-600 dark:text-gray-400'}`}>{h.tag}</span>
                                        <span className="text-xs bg-gray-200 dark:bg-gray-700 px-1.5 rounded-md text-gray-500">{h.count}</span>
                                    </div>
                                ))}
                                {hashtagStats.length === 0 && <p className="text-gray-400 text-sm text-center py-4 w-full">No hashtags found</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ onClose, platforms, setPlatforms, statuses, setStatuses, pillars, setPillars, topics, setTopics, defaultView, setDefaultView }) => {
            const [activeTab, setActiveTab] = React.useState('general');
            const [editingId, setEditingId] = React.useState(null); 
            const [editForm, setEditForm] = React.useState({ label: '', icon: 'ph-hash', color: 'bg-gray-500' });
            const [draggedItemIndex, setDraggedItemIndex] = React.useState(null);

            // Softer color palette for settings controls
            const colors = [
                'bg-red-300', 'bg-orange-300', 'bg-amber-300', 'bg-yellow-300', 
                'bg-lime-300', 'bg-green-300', 'bg-emerald-300', 'bg-teal-300', 
                'bg-cyan-300', 'bg-sky-300', 'bg-blue-300', 'bg-indigo-300', 
                'bg-violet-300', 'bg-purple-300', 'bg-fuchsia-300', 'bg-pink-300', 
                'bg-rose-300', 'bg-slate-500', 'bg-gray-700'
            ];
            
            const commonIcons = [
                'ph-lightbulb', 'ph-pencil-simple', 'ph-calendar-check', 'ph-check-circle', 'ph-graduation-cap', 'ph-sparkle', 'ph-megaphone', 'ph-eye', 'ph-users', 'ph-hash', 'ph-chats', 'ph-newspaper', 'ph-monitor', 'ph-package', 'ph-tag', 'ph-bookmark-simple', 'ph-star', 'ph-gear-six', 'ph-fingerprint', 'ph-rocket-launch'
            ];
            
            const platformIcons = ['ph-instagram-logo', 'ph-facebook-logo', 'ph-tiktok-logo', 'ph-youtube-logo', 'ph-linkedin-logo', 'ph-twitter-logo', 'ph-snapchat-logo', 'ph-pinterest-logo', 'ph-globe', 'ph-article', 'ph-camera', 'ph-video'];

            const getActiveList = () => {
                switch(activeTab) {
                    case 'platforms': return platforms;
                    case 'statuses': return statuses;
                    case 'pillars': return pillars;
                    case 'topics': return topics;
                    default: return {};
                }
            };

            const setActiveList = (newList) => {
                switch(activeTab) {
                    case 'platforms': setPlatforms(newList); break;
                    case 'statuses': setStatuses(newList); break;
                    case 'pillars': setPillars(newList); break;
                    case 'topics': setTopics(newList); break;
                }
            };

            const startEdit = (item) => {
                setEditingId(item.id);
                // Ensure default icon for non-platform categories if missing
                setEditForm({ 
                    ...item,
                    icon: item.icon || (activeTab === 'platforms' ? 'ph-hash' : 'ph-tag') 
                });
            };

            const saveEdit = () => {
                const list = getActiveList();
                setActiveList({ ...list, [editingId]: { ...editForm, id: editingId } });
                resetForm();
            };

            const addNew = () => {
                if (!editForm.label) return;
                const id = generateId();
                const list = getActiveList();
                let defaultColor = 'bg-gray-500';
                let defaultIcon = 'ph-tag';

                if (activeTab === 'statuses') { defaultColor = 'bg-gray-100 text-gray-700'; defaultIcon = 'ph-tag'; }
                if (activeTab === 'pillars') { defaultColor = 'bg-blue-100 text-blue-700'; defaultIcon = 'ph-hash'; }
                if (activeTab === 'topics') { defaultColor = 'bg-gray-100 text-gray-600'; defaultIcon = 'ph-chats'; }
                
                setActiveList({ ...list, [id]: { 
                    ...editForm, 
                    id, 
                    color: editForm.color || defaultColor,
                    icon: editForm.icon || defaultIcon
                } });
                resetForm();
            };

            const deleteItem = (id) => {
                if(!confirm("Are you sure you want to delete this?")) return;
                const list = { ...getActiveList() };
                delete list[id];
                setActiveList(list);
                if (editingId === id) resetForm();
            };

            const resetForm = () => {
                setEditingId(null);
                setEditForm({ label: '', icon: 'ph-hash', color: '' });
            };

            const handleDefaultViewChange = (view) => {
                setDefaultView(view);
                localStorage.setItem('omniplan_default_view', view);
            };

            // Drag and Drop Handlers
            const handleDragStart = (e, index) => {
                setDraggedItemIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === dropIndex) return;

                const currentList = Object.values(getActiveList());
                const newListArray = [...currentList];
                const [movedItem] = newListArray.splice(draggedItemIndex, 1);
                newListArray.splice(dropIndex, 0, movedItem);

                // Reconstruct object with new order
                const newObj = {};
                newListArray.forEach(item => {
                    newObj[item.id] = item;
                });

                setActiveList(newObj);
                setDraggedItemIndex(null);
            };

            const iconOptions = activeTab === 'platforms' ? platformIcons : commonIcons;

            return (
                <div className="fixed inset-0 bg-black/30 backdrop-blur-md flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-[#1C1C1E] rounded-[2rem] w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in-up">
                        <div className="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-white/50 dark:bg-black/20 backdrop-blur-xl">
                            <h3 className="font-bold text-xl dark:text-white">Settings</h3>
                            <button onClick={onClose} className="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-200 transition"><i className="ph ph-x"></i></button>
                        </div>
                        
                        <div className="flex p-2 m-4 bg-gray-100 dark:bg-gray-800 rounded-xl overflow-x-auto gap-2">
                            {['general', 'platforms', 'statuses', 'pillars', 'topics'].map(tab => (
                                <button 
                                    key={tab}
                                    onClick={() => { setActiveTab(tab); resetForm(); }} 
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap capitalize ${activeTab === tab ? 'bg-white dark:bg-gray-700 shadow-sm text-black dark:text-white' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 pb-6">
                            {activeTab === 'general' ? (
                                <div className="space-y-6">
                                    <div className="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-2xl border border-gray-100 dark:border-gray-700">
                                        <h4 className="text-sm font-bold uppercase text-gray-400 mb-4">Default View</h4>
                                        <p className="text-xs text-gray-500 mb-3">Choose the view that opens when you start the app.</p>
                                        <div className="grid grid-cols-2 gap-3">
                                            {['month', 'status', 'list', 'reports'].map(view => (
                                                <button 
                                                    key={view}
                                                    onClick={() => handleDefaultViewChange(view)}
                                                    className={`p-3 rounded-xl border-2 text-sm font-bold capitalize transition-all ${defaultView === view ? 'border-iosBlue bg-blue-50 dark:bg-blue-900/20 text-iosBlue' : 'border-gray-200 dark:border-gray-700 text-gray-500 hover:border-gray-300'}`}
                                                >
                                                    {view === 'month' ? 'Calendar' : view}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-2xl mb-6 border border-gray-100 dark:border-gray-700">
                                        <h4 className="text-xs font-bold uppercase text-gray-400 mb-4">{editingId ? 'Edit Item' : 'Add New Item'}</h4>
                                        <div className="space-y-4">
                                            <input 
                                                type="text" 
                                                placeholder="Label Name" 
                                                className="w-full p-3 bg-white dark:bg-gray-900 rounded-xl border-none outline-none focus:ring-2 focus:ring-iosBlue/50" 
                                                value={editForm.label} 
                                                onChange={e => setEditForm({...editForm, label: e.target.value})} 
                                            />
                                            
                                            <div className="space-y-2">
                                                <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Icon</label>
                                                <div className="grid grid-cols-8 gap-2 bg-white dark:bg-gray-900 p-3 rounded-xl">
                                                    {iconOptions.map(icon => (
                                                        <button 
                                                            key={icon} 
                                                            onClick={() => setEditForm({...editForm, icon})} 
                                                            className={`p-2 rounded-lg text-xl flex justify-center ${editForm.icon === icon ? 'bg-iosBlue text-white' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                                                        >
                                                            <i className={`ph ${icon}`}></i>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="flex flex-wrap gap-3">
                                                {colors.map(c => (
                                                    <button key={c} onClick={() => setEditForm({...editForm, color: c})} className={`w-8 h-8 rounded-full ${c} ${editForm.color?.includes(c) ? 'ring-2 ring-offset-2 ring-iosBlue' : ''} shadow-sm`}></button>
                                                ))}
                                            </div>

                                            <div className="flex gap-2 pt-2">
                                                {editingId ? (
                                                    <>
                                                        <button onClick={saveEdit} className="flex-1 bg-iosBlue text-white py-3 rounded-xl font-semibold shadow-lg shadow-blue-500/20">Save Changes</button>
                                                        <button onClick={resetForm} className="px-6 bg-gray-200 dark:bg-gray-700 rounded-xl font-semibold">Cancel</button>
                                                    </>
                                                ) : (
                                                    <button onClick={addNew} className="flex-1 bg-black dark:bg-white text-white dark:text-black py-3 rounded-xl font-semibold">Add New</button>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        <p className="text-xs text-gray-400 text-center italic">Drag items to reorder</p>
                                        {Object.values(getActiveList()).map((item, index) => (
                                            <div 
                                                key={item.id} 
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={(e) => handleDragOver(e, index)}
                                                onDrop={(e) => handleDrop(e, index)}
                                                onClick={() => startEdit(item)} 
                                                className="flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-iosBlue transition-colors group relative"
                                            >
                                                <div className="flex items-center gap-4">
                                                    <i className="ph ph-dots-six-vertical text-gray-300 cursor-grab active:cursor-grabbing"></i>
                                                    {/* Display Icon and Color based on category */}
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white ${item.color.includes('bg-') ? item.color.split(' ')[0] : 'bg-gray-500'} shadow-md`}>
                                                        {item.icon ? (
                                                            <i className={`ph ${item.icon} text-lg ${item.color.includes('text-') ? item.color.split(' ').find(c => c.startsWith('text-')) : 'text-white'}`}></i>
                                                        ) : (
                                                            <div className={`w-4 h-4 rounded-full ${item.color.split(' ')[0]}`}></div>
                                                        )}
                                                    </div>
                                                    <span className="font-semibold text-lg dark:text-white">{item.label}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); deleteItem(item.id); }} 
                                                        className="w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition"
                                                    >
                                                        <i className="ph ph-trash text-lg"></i>
                                                    </button>
                                                    <div className="text-gray-300 group-hover:text-iosBlue">
                                                        <i className="ph ph-pencil-simple text-xl"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const DraggableCard = ({ item, onDragStart, onClick, onLongPress, mini, platforms, statuses, pillars, isMultiDayStart, isMultiDayEnd, isMultiDayMiddle, isTemplate = false, isBulkSelecting, isSelected, onToggleSelect }) => {
            const pillar = pillars[item.contentPillar] || pillars.other; // Use pillar for main visual
            const status = statuses[item.status] || {color: 'text-gray-500', label: item.status};
            const pIds = Array.isArray(item.platform) ? item.platform : (item.platform ? [item.platform] : []); // Ensure pIds is an array
            const progress = item.progress || 0;
            const deliverables = item.deliverables || [];
            const completedDeliverables = deliverables.filter(d => d.completed).length;

            const longPressRef = React.useRef(null);
            const hasLongPressed = React.useRef(false); 
            const isDragging = React.useRef(false); // New flag to track dragging

            const handleMouseDown = (e) => {
                e.stopPropagation();
                hasLongPressed.current = false;
                isDragging.current = false;
                
                // Start long press timer
                longPressRef.current = setTimeout(() => {
                    hasLongPressed.current = true; 
                    onLongPress(item.id, isTemplate);
                }, LONG_PRESS_DURATION); 
            };
            
            const handleMouseMove = (e) => {
                if(longPressRef.current && !isDragging.current) {
                    // Check for movement significant enough to start a drag
                    // We clear the timeout here on any mouse move to favor drag over long-press, 
                    // unless a long press has already fired.
                    if (!hasLongPressed.current) {
                        clearTimeout(longPressRef.current);
                        longPressRef.current = null;
                    }
                }
            };

            const handleMouseUp = (e) => {
                clearTimeout(longPressRef.current);
                longPressRef.current = null; // Clear timeout reference
                
                // If a long press did NOT occur and we weren't dragging, execute click/toggle
                if (!hasLongPressed.current && !isDragging.current) {
                    handleMouseClick(e);
                }
                
                // Reset flags after handling the interaction
                hasLongPressed.current = false;
                isDragging.current = false;
            };

            const handleMouseClick = (e) => {
                e.stopPropagation();
                
                if (!isBulkSelecting) {
                    onClick(item.id, isTemplate);
                } else {
                    onToggleSelect(item.id, isTemplate);
                }
            };

            const handleDrag = (e) => {
                // Drag start logic
                clearTimeout(longPressRef.current); // Important: clear long press when drag starts
                isDragging.current = true;
                
                // Only allow drag if not in bulk select mode OR if the item is selected
                if (!isBulkSelecting || isSelected) {
                    onDragStart(e, item, isTemplate);
                    // For bulk drag, the effect is handled by the App component
                    if (isBulkSelecting) {
                         e.dataTransfer.setData('isBulkDrag', 'true');
                    } else if (isTemplate) {
                        e.dataTransfer.effectAllowed = 'copy';
                    } else {
                        e.dataTransfer.effectAllowed = 'move';
                    }
                } else {
                    e.preventDefault();
                }
            };

            let cardStyle = `group relative shadow-sm transition-all border border-gray-100 dark:border-gray-700 overflow-hidden ${mini ? 'p-2' : 'p-4 mb-3'}`;
            
            if (isTemplate) {
                 cardStyle += ' bg-yellow-50 dark:bg-amber-900/40 border-yellow-200 dark:border-amber-700';
            } else {
                 cardStyle += ' bg-white dark:bg-[#2C2C2E]';
            }
            
            if (isSelected) {
                cardStyle += ' ring-2 ring-offset-1 ring-iosBlue';
            }
            
            // Standard drag behavior override for bulk selecting
            cardStyle += isBulkSelecting ? ' cursor-pointer hover:shadow-lg' : ' cursor-grab active:cursor-grabbing hover:shadow-lg';


            if (isMultiDayStart) cardStyle += ' rounded-r-none border-r-0 mr-[-8px] z-10';
            if (isMultiDayEnd) cardStyle += ' rounded-l-none border-l-0 ml-[-8px] z-10';
            if (isMultiDayMiddle) cardStyle += ' rounded-none border-x-0 mx-[-8px] opacity-80 z-0';
            
            return (
                <div 
                    draggable={!isBulkSelecting || isSelected} 
                    onDragStart={handleDrag} 
                    onClick={(e) => { e.stopPropagation(); }} // Prevent immediate click on drag-end if possible
                    onMouseDown={handleMouseDown}
                    onMouseUp={handleMouseUp}
                    onMouseMove={handleMouseMove} // Added for better drag detection
                    onTouchStart={handleMouseDown}
                    onTouchEnd={handleMouseUp}
                    className={cardStyle}
                >
                    <div className="absolute top-2 left-2 z-20">
                        {isBulkSelecting && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); onToggleSelect(item.id, isTemplate); }}
                                className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${isSelected ? 'bg-iosBlue border-iosBlue text-white' : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600'}`}
                            >
                                {isSelected && <i className="ph ph-check text-xs"></i>}
                            </button>
                        )}
                    </div>
                    
                    <div className={`${isBulkSelecting ? 'ml-6' : ''}`}>
                        {(item.image || item.video) && (
                            <div className="w-full h-24 mb-2 rounded-xl overflow-hidden bg-gray-100 relative">
                                {item.image ? <img src={item.image} className="w-full h-full object-cover" /> : <video src={item.video} className="w-full h-full object-cover" />}
                                <div className="absolute inset-0 bg-black/10 flex items-center justify-center">
                                    {item.video && <i className="ph ph-play-circle text-white text-3xl drop-shadow-md"></i>}
                                </div>
                            </div>
                        )}
                        <div className="flex items-center gap-3">
                            {/* Display Pillar Icon and Color as the main badge */}
                            <div title={pillar.label} className={`w-8 h-8 rounded-full flex items-center justify-center text-white shadow-md ring-2 ring-white dark:ring-[#2C2C2E] ${pillar.color.split(' ')[0]}`}>
                                <i className={`ph ${pillar.icon} text-lg ${pillar.color.includes('text-') ? pillar.color.split(' ').find(c => c.startsWith('text-')) : 'text-white'}`}></i>
                            </div>
                            
                            <div className="flex-1 min-w-0">
                                <h4 className={`font-semibold truncate text-gray-900 dark:text-white ${mini ? 'text-xs' : 'text-sm'}`}>{item.title || (isTemplate ? 'Untitled Template' : 'Untitled Content')}</h4>
                                {!mini && isTemplate && <span className="text-[10px] font-bold text-yellow-600 dark:text-yellow-400">TEMPLATE</span>}
                                {!mini && (
                                    <div className="flex items-center justify-between mt-1">
                                        <div className="flex items-center gap-1">
                                            {/* Display Status */}
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${status.color}`}>{status.label}</span>
                                            
                                            {/* Date Display (NEW) */}
                                            {item.date && (
                                                <div className="flex items-center gap-1 text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded-full text-gray-500">
                                                    <i className="ph ph-calendar text-xs"></i>
                                                    <span className="font-medium">{formatDate(item.date)}</span>
                                                </div>
                                            )}

                                            {/* Display Platform Icons (small overlay/group) */}
                                            {pIds.length > 0 && (
                                                <div className="flex -space-x-1 py-1">
                                                    {pIds.map(pid => {
                                                        const p = platforms[pid];
                                                        if (!p) return null; // FIX: Skip rendering if platform ID is invalid/stale
                                                        return (
                                                            <div key={pid} title={p.label} className={`w-4 h-4 rounded-full flex items-center justify-center text-white ring-1 ring-white dark:ring-[#2C2C2E] ${p.color} text-[8px]`}>
                                                                <i className={`ph ${p.icon}`}></i>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}

                                            {deliverables.length > 0 && (
                                                <div className="flex items-center gap-1 text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded-full text-gray-500">
                                                    <i className="ph ph-check-square"></i>
                                                    <span>{completedDeliverables}/{deliverables.length}</span>
                                                </div>
                                            )}
                                        </div>
                                        {progress > 0 && <span className="text-[10px] font-bold text-gray-400">{progress}%</span>}
                                    </div>
                                )}
                                {!mini && progress > 0 && (
                                    <div className="w-full bg-gray-100 dark:bg-gray-700 h-1 mt-2 rounded-full overflow-hidden">
                                        <div className="bg-iosBlue h-full rounded-full transition-all duration-300" style={{width: `${progress}%`}}></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BulkEditModal = ({ selectedItemIds, items, templates, platforms, statuses, pillars, onUpdateBulk, onClose }) => {
            const [editForm, setEditForm] = React.useState({
                status: '',
                platform: [],
                contentPillar: '',
                progress: 0,
            });

            // Find common values for initial form state (not strictly necessary but nice UX)
            React.useEffect(() => {
                const initialStatus = items.filter(i => selectedItemIds.includes('I:' + i.id)).map(i => i.status)[0] || '';
                const initialPillar = items.filter(i => selectedItemIds.includes('I:' + i.id)).map(i => i.contentPillar)[0] || '';
                
                setEditForm({
                    status: initialStatus,
                    platform: [], // Start platforms as empty array to indicate 'overwrite/set'
                    contentPillar: initialPillar,
                    progress: 0,
                });
            }, [selectedItemIds, items]);

            const handleUpdate = () => {
                onUpdateBulk(editForm);
            };
            
            const togglePlatform = (pId) => {
                const current = editForm.platform;
                if (current.includes(pId)) {
                    setEditForm({ ...editForm, platform: current.filter(id => id !== pId) });
                } else {
                    setEditForm({ ...editForm, platform: [...current, pId] });
                }
            };
            
            const totalItems = selectedItemIds.length;

            return (
                 <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-[#1C1C1E] rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in-up">
                        <div className="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl">
                            <h3 className="font-bold text-xl dark:text-white">Group Edit ({totalItems} Items)</h3>
                            <button onClick={onClose} className="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-200 transition"><i className="ph ph-x"></i></button>
                        </div>
                        <div className="p-6 space-y-6">
                            
                            <p className="text-sm text-gray-500">Only fill in the fields you wish to update across all {totalItems} selected items. Leaving a field empty/unchecked will keep the current values.</p>

                            {/* Status */}
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Set Status</label>
                                <select className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={editForm.status} onChange={e => setEditForm({...editForm, status: e.target.value})}>
                                    <option value="">-- Leave Unchanged --</option>
                                    {Object.values(statuses).map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                </select>
                            </div>

                            {/* Content Pillar */}
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Set Content Pillar</label>
                                <select className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={editForm.contentPillar} onChange={e => setEditForm({...editForm, contentPillar: e.target.value})}>
                                    <option value="">-- Leave Unchanged --</option>
                                    {Object.values(pillars).map(p => <option key={p.id} value={p.id}>{p.label}</option>)}
                                </select>
                            </div>

                            {/* Platforms (Set/Overwrite) */}
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Set Platforms (Will overwrite existing)</label>
                                <div className="flex flex-wrap gap-2 bg-gray-100 dark:bg-gray-800 p-3 rounded-xl">
                                    {Object.values(platforms).map(p => (
                                        <button 
                                            key={p.id}
                                            onClick={() => togglePlatform(p.id)}
                                            className={`flex items-center gap-2 px-3 py-2 rounded-xl border transition ${editForm.platform.includes(p.id) ? 'border-iosBlue bg-blue-50 dark:bg-blue-900/30 text-iosBlue' : 'border-gray-200 dark:border-gray-700 text-gray-500 hover:border-gray-300'}`}
                                        >
                                            <i className={`ph ${p.icon} text-lg`}></i>
                                            <span className="text-xs font-bold">{p.label}</span>
                                        </button>
                                    ))}
                                    {editForm.platform.length === 0 && <span className="text-xs italic text-gray-400">No platforms selected. Platforms will be cleared on save.</span>}
                                </div>
                            </div>
                            
                            {/* Progress */}
                            <div className="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl border border-gray-100 dark:border-gray-700">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs font-bold text-gray-400 uppercase">Set Progress</label>
                                    <span className="text-xs font-bold text-iosBlue">{editForm.progress}%</span>
                                </div>
                                <input type="range" min="0" max="100" step="5" value={editForm.progress} onChange={e => setEditForm({...editForm, progress: parseInt(e.target.value)})} />
                            </div>

                        </div>
                        <div className="p-5 border-t border-gray-100 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl flex justify-end">
                            <button onClick={handleUpdate} className="px-8 bg-iosBlue text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/20 hover:scale-[1.02] transition-transform">Apply Changes</button>
                        </div>
                    </div>
                </div>
            );
        };


        const EventForm = ({ initialData, onSave, onDelete, onClose }) => {
            const [formData, setFormData] = React.useState({
                title: '',
                date: '',
                endDate: '',
                color: 'bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-200',
                recurrence: 'none',
                recurrenceInterval: 1,
                ...initialData
            });

            const colors = [
                { label: 'Red', val: 'bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-200' },
                { label: 'Green', val: 'bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-200' },
                { label: 'Blue', val: 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-200' },
                { label: 'Orange', val: 'bg-orange-100 text-orange-600 dark:bg-orange-900/40 dark:text-orange-200' },
                { label: 'Purple', val: 'bg-purple-100 text-purple-600 dark:bg-purple-900/40 dark:text-purple-200' },
                { label: 'Gray', val: 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-200' },
            ];

            return (
                <div className="p-6 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-xl dark:text-white">{initialData.id ? 'Edit Event' : 'New Event'}</h3>
                        <button onClick={onClose} className="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-200 transition"><i className="ph ph-x"></i></button>
                    </div>

                    <div className="space-y-4 flex-1">
                        <div>
                            <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Event Name</label>
                            <input 
                                type="text" 
                                autoFocus
                                className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-2xl text-lg font-bold outline-none focus:ring-2 focus:ring-iosBlue/50 dark:text-white" 
                                placeholder="e.g. Christmas, Launch Day" 
                                value={formData.title} 
                                onChange={e => setFormData({...formData, title: e.target.value})} 
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Start Date</label>
                                <input 
                                    type="date" 
                                    className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none dark:text-white" 
                                    value={formData.date} 
                                    onChange={e => setFormData({...formData, date: e.target.value})} 
                                />
                            </div>
                             <div>
                                <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">End Date (Optional)</label>
                                <input 
                                    type="date" 
                                    className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none dark:text-white" 
                                    value={formData.endDate || ''} 
                                    onChange={e => setFormData({...formData, endDate: e.target.value})} 
                                />
                            </div>
                        </div>

                        <div>
                            <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Repeat</label>
                            <div className="flex gap-2">
                                <select 
                                    className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none dark:text-white"
                                    value={formData.recurrence}
                                    onChange={e => setFormData({...formData, recurrence: e.target.value})}
                                >
                                    {RECURRENCE_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                                </select>
                                {formData.recurrence === 'every_x_days' && (
                                    <input 
                                        type="number" 
                                        min="1"
                                        className="w-24 p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none dark:text-white text-center"
                                        value={formData.recurrenceInterval} 
                                        onChange={e => setFormData({...formData, recurrenceInterval: e.target.value})} 
                                        placeholder="Days"
                                    />
                                )}
                            </div>
                        </div>

                        <div>
                            <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Color Theme</label>
                            <div className="flex flex-wrap gap-2">
                                {/* Only use the first part of the class for the color selector display */}
                                {colors.map(c => (
                                    <button 
                                        key={c.label}
                                        onClick={() => setFormData({...formData, color: c.val})}
                                        className={`w-8 h-8 rounded-full transition border-2 shadow-sm ${c.val.split(' ')[0]} ${formData.color === c.val ? 'ring-2 ring-offset-2 ring-iosBlue' : 'border-transparent'}`}
                                        title={c.label}
                                    >
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-3 mt-6">
                        {onDelete && <button onClick={onDelete} className="px-6 py-4 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-2xl hover:bg-red-100 transition">Delete</button>}
                        <button onClick={() => onSave(formData)} className="flex-1 bg-iosBlue text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20 hover:scale-[1.02] transition-transform">Save Event</button>
                    </div>
                </div>
            );
        };

        const ContentForm = ({ initialData, onSave, onDelete, onDuplicate, platforms, statuses, pillars, topics, onClose, isTemplate = false, saveTemplate, deleteTemplate, duplicateTemplate }) => {
            
            // Calculate platform as array: 
            // 1. If initialData.platform is present, use it (convert string to array if needed). 
            // 2. If it's a new item (no initialData.platform), start with []
            const initialPlatformArray = initialData.platform 
                ? (Array.isArray(initialData.platform) ? initialData.platform : [initialData.platform]) 
                : []; // FIX: Default to empty array for new content

            const [formData, setFormData] = React.useState({ 
                title: '', 
                status: Object.keys(statuses)[0] || '', date: '', caption: '', 
                projectId: 'default', image: null, video: null, 
                contentPillar: '', mediaType: 'Image', topic: '', contentLink: '', inspiration: '', callToAction: '', 
                videoScript: '', audioSound: '', hashtags: '', approvalStatus: 'Draft', progress: 0,
                deliverables: [],
                ...initialData,
                platform: initialPlatformArray, // FIX: Explicitly set platform to the calculated array
                deliverables: initialData.deliverables || []
            });
            const [activeSection, setActiveSection] = React.useState('core');
            const [showEmojiPicker, setShowEmojiPicker] = React.useState(false);
            const [emojiCategory, setEmojiCategory] = React.useState('Popular');
            const [newTask, setNewTask] = React.useState('');

            const handleFile = (e, type) => {
                const file = e.target.files[0];
                if(file) {
                    // REMOVED file size check. Media is now only stored locally.
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData({...formData, [type]: reader.result, [type === 'image' ? 'video' : 'image']: null});
                    reader.readAsDataURL(file);
                }
            };
            
            const insertEmoji = (emoji) => {
                setFormData(prev => ({...prev, caption: prev.caption + emoji}));
                setShowEmojiPicker(false);
            };

            const togglePlatform = (pId) => {
                const current = formData.platform;
                if (current.includes(pId)) {
                    setFormData({ ...formData, platform: current.filter(id => id !== pId) });
                } else {
                    setFormData({ ...formData, platform: [...current, pId] });
                }
            };

            const addTask = (e) => {
                e.preventDefault();
                if(!newTask.trim()) return;
                const task = { id: generateId(), text: newTask.trim(), completed: false };
                setFormData({ ...formData, deliverables: [...(formData.deliverables || []), task] });
                setNewTask('');
            };

            const toggleTask = (taskId) => {
                const updated = (formData.deliverables || []).map(t => 
                    t.id === taskId ? { ...t, completed: !t.completed } : t
                );
                setFormData({ ...formData, deliverables: updated });
            };

            const deleteTask = (taskId) => {
                const updated = (formData.deliverables || []).filter(t => t.id !== taskId);
                setFormData({ ...formData, deliverables: updated });
            };

            const handleSave = () => {
                if (isTemplate && saveTemplate) {
                    // Templates should never have a date
                    saveTemplate({...formData, date: null});
                } else if (onSave) {
                    onSave(formData);
                }
            };

            const handleDelete = () => {
                if (isTemplate && deleteTemplate) {
                    deleteTemplate(formData.id);
                } else if (onDelete) {
                    onDelete(formData.id);
                }
            };

            const handleDuplicate = () => {
                if (isTemplate && duplicateTemplate) {
                    duplicateTemplate(formData);
                } else if (onDuplicate) {
                    onDuplicate(formData);
                }
            };

            const sections = [
                { id: 'core', label: 'Details' },
                { id: 'strategy', label: 'Strategy' },
                { id: 'creative', label: 'Creative' },
                { id: 'media', label: 'Media' },
                { id: 'tasks', label: 'Tasks' }
            ];

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <div className="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl sticky top-0 z-20">
                        <h3 className="font-bold text-xl dark:text-white">{isTemplate ? (initialData.id ? 'Edit Template' : 'New Template') : (initialData.id ? 'Edit Content' : 'New Content')}</h3>
                        <button onClick={onClose} className="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-200 transition"><i className="ph ph-x"></i></button>
                    </div>

                    {/* Tabs */}
                    <div className="px-5 pt-4 pb-2 bg-white dark:bg-gray-900 border-b border-gray-100 dark:border-gray-800 flex gap-2 overflow-x-auto">
                        {sections.map(sec => (
                            <button 
                                key={sec.id}
                                onClick={() => setActiveSection(sec.id)}
                                className={`px-4 py-2 rounded-full text-xs font-bold transition whitespace-nowrap ${activeSection === sec.id ? 'bg-iosBlue text-white shadow-lg shadow-blue-500/30' : 'bg-gray-100 dark:bg-gray-800 text-gray-500 hover:bg-gray-200'}`}
                            >
                                {sec.label}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                        
                        {activeSection === 'core' && (
                            <div className="space-y-4 animate-fade-in">
                                <input type="text" className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-2xl text-lg font-bold outline-none focus:ring-2 focus:ring-iosBlue/50 dark:text-white" placeholder="Content Title" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                                
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Platforms</label>
                                    <div className="flex flex-wrap gap-2">
                                        {Object.values(platforms).map(p => (
                                            <button 
                                                key={p.id}
                                                onClick={() => togglePlatform(p.id)}
                                                className={`flex items-center gap-2 px-3 py-2 rounded-xl border transition ${formData.platform.includes(p.id) ? 'border-iosBlue bg-blue-50 dark:bg-blue-900/30 text-iosBlue' : 'border-gray-200 dark:border-gray-700 text-gray-500 hover:border-gray-300'}`}
                                            >
                                                <i className={`ph ${p.icon} text-lg`}></i>
                                                <span className="text-xs font-bold">{p.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Status</label>
                                        <select className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                                            {Object.values(statuses).map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                        </select>
                                    </div>
                                    {!isTemplate && (
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Scheduled Date</label>
                                            <input type="date" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={formData.date || ''} onChange={e => setFormData({...formData, date: e.target.value})} />
                                        </div>
                                    )}
                                </div>

                                <div className="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl border border-gray-100 dark:border-gray-700">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-xs font-bold text-gray-400 uppercase">Progress</label>
                                        <span className="text-xs font-bold text-iosBlue">{formData.progress}%</span>
                                    </div>
                                    <input type="range" min="0" max="100" step="5" value={formData.progress} onChange={e => setFormData({...formData, progress: parseInt(e.target.value)})} />
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Approval Status</label>
                                    <div className="flex flex-wrap gap-2">
                                        {APPROVAL_STATUSES.map(s => (
                                            <button 
                                                key={s} 
                                                onClick={() => setFormData({...formData, approvalStatus: s})}
                                                className={`px-3 py-1.5 rounded-lg text-xs font-semibold border transition ${formData.approvalStatus === s ? 'bg-black text-white dark:bg-white dark:text-black border-transparent' : 'border-gray-200 dark:border-gray-700 text-gray-500'}`}
                                            >
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                         {activeSection === 'strategy' && (
                            <div className="space-y-4 animate-fade-in">
                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Content Pillar</label>
                                    <select className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={formData.contentPillar} onChange={e => setFormData({...formData, contentPillar: e.target.value})}>
                                        <option value="">Select a Pillar</option>
                                        {Object.values(pillars).map(p => <option key={p.id} value={p.id}>{p.label}</option>)}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Topic</label>
                                    <select className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={formData.topic} onChange={e => setFormData({...formData, topic: e.target.value})}>
                                        <option value="">Select a Topic</option>
                                        {Object.values(topics).map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Media Type</label>
                                    <select className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" value={formData.mediaType} onChange={e => setFormData({...formData, mediaType: e.target.value})}>
                                        {MEDIA_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Call to Action (CTA)</label>
                                    <input type="text" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" placeholder="e.g. Link in Bio, Comment below..." value={formData.callToAction} onChange={e => setFormData({...formData, callToAction: e.target.value})} />
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Content Link (Draft/Live)</label>
                                    <input type="url" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" placeholder="https://..." value={formData.contentLink} onChange={e => setFormData({...formData, contentLink: e.target.value})} />
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Inspiration / Notes</label>
                                    <textarea rows="3" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" placeholder="References, ideas..." value={formData.inspiration} onChange={e => setFormData({...formData, inspiration: e.target.value})}></textarea>
                                </div>
                            </div>
                        )}

                        {activeSection === 'creative' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="relative">
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Caption</label>
                                    <textarea rows="5" className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-2xl outline-none" placeholder="Write engaging copy..." value={formData.caption} onChange={e => setFormData({...formData, caption: e.target.value})}></textarea>
                                    <button 
                                        onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                        className="absolute bottom-4 right-4 text-gray-400 hover:text-iosBlue transition p-2 rounded-lg hover:bg-white/10"
                                    >
                                        <i className="ph ph-smiley text-2xl"></i>
                                    </button>
                                     {/* Emoji Picker Popover */}
                                    {showEmojiPicker && (
                                        <div className="absolute bottom-16 right-0 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-72 h-80 flex flex-col border border-gray-100 dark:border-gray-700 z-30 animate-fade-in-up overflow-hidden">
                                            <div className="flex overflow-x-auto p-2 border-b border-gray-100 dark:border-gray-700 gap-1 scrollbar-hide">
                                                {Object.keys(FULL_EMOJI_LIST).map(cat => (
                                                    <button 
                                                        key={cat} 
                                                        onClick={() => setEmojiCategory(cat)}
                                                        className={`px-3 py-1 text-xs rounded-full whitespace-nowrap transition ${emojiCategory === cat ? 'bg-iosBlue text-white' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                                    >
                                                        {cat}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="flex-1 overflow-y-auto p-2">
                                                <div className="emoji-grid">
                                                    {FULL_EMOJI_LIST[emojiCategory].map(em => (
                                                        <button 
                                                            key={em} 
                                                            onClick={() => insertEmoji(em)} 
                                                            className="h-8 w-8 flex items-center justify-center text-xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
                                                        >
                                                            {em}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Hashtags</label>
                                    <textarea rows="2" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" placeholder="#content #strategy..." value={formData.hashtags} onChange={e => setFormData({...formData, hashtags: e.target.value})}></textarea>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Video Script / Copy</label>
                                    <textarea rows="4" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" placeholder="Script or talking points..." value={formData.videoScript} onChange={e => setFormData({...formData, videoScript: e.target.value})}></textarea>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-2 mb-1 block">Audio Sound</label>
                                    <input type="text" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl outline-none" placeholder="Trending Audio Name / Link" value={formData.audioSound} onChange={e => setFormData({...formData, audioSound: e.target.value})} />
                                </div>
                            </div>
                        )}

                        {activeSection === 'media' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className={`border-2 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer transition ${formData.image ? 'border-iosBlue bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}`} onClick={() => document.getElementById('imageInput').click()}>
                                        <input type="file" id="imageInput" accept="image/*" className="hidden" onChange={(e) => handleFile(e, 'image')} />
                                        <i className="ph ph-image text-3xl mb-2 text-gray-400"></i>
                                        <span className="text-sm font-bold text-gray-500">Upload Image</span>
                                    </div>
                                    <div className={`border-2 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer transition ${formData.video ? 'border-iosBlue bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}`} onClick={() => document.getElementById('videoInput').click()}>
                                        <input type="file" id="videoInput" accept="video/*" className="hidden" onChange={(e) => handleFile(e, 'video')} />
                                        <i className="ph ph-film-strip text-3xl mb-2 text-gray-400"></i>
                                        <span className="text-sm font-bold text-gray-500">Upload Video</span>
                                    </div>
                                </div>

                                {(formData.image || formData.video) && (
                                    <>
                                        {/* OFFLINE STORAGE BANNER */}
                                        <div className="p-4 bg-yellow-50 dark:bg-yellow-900/40 rounded-xl border border-yellow-200 dark:border-yellow-700 flex items-center gap-3">
                                            <i className="ph ph-cloud-slash text-xl text-yellow-600"></i>
                                            <span className="text-sm font-medium text-yellow-800 dark:text-yellow-300">
                                                Media is stored offline (in your browser) and will not be synced to the cloud.
                                            </span>
                                        </div>
                                        {/* END OFFLINE STORAGE BANNER */}

                                        <div className="relative rounded-2xl overflow-hidden bg-black shadow-lg">
                                            {formData.image && <img src={formData.image} className="w-full h-auto max-h-[400px] object-contain mx-auto" />}
                                            {formData.video && <video src={formData.video} controls className="w-full h-auto max-h-[400px] mx-auto" />}
                                            <button 
                                                onClick={() => setFormData({...formData, image: null, video: null})}
                                                className="absolute top-4 right-4 bg-black/50 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-500 transition backdrop-blur-sm"
                                            >
                                                <i className="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </>
                                )}
                                
                                {!formData.image && !formData.video && (
                                    <div className="text-center py-10 text-gray-400 text-sm italic bg-gray-50 dark:bg-gray-800/50 rounded-2xl border border-gray-100 dark:border-gray-700">
                                        No media attached yet.
                                    </div>
                                )}
                            </div>
                        )}

                        {activeSection === 'tasks' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-2xl border border-gray-100 dark:border-gray-700">
                                    <h4 className="text-sm font-bold uppercase text-gray-400 mb-4">Deliverables & To-Dos</h4>
                                    
                                    {/* Input */}
                                    <form onSubmit={addTask} className="flex gap-2 mb-6">
                                        <input 
                                            type="text" 
                                            className="flex-1 p-3 bg-white dark:bg-gray-900 rounded-xl border-none outline-none focus:ring-2 focus:ring-iosBlue/50"
                                            placeholder="Add a new task..."
                                            value={newTask}
                                            onChange={(e) => setNewTask(e.target.value)}
                                        />
                                        <button type="submit" className="bg-black dark:bg-white text-white dark:text-black px-4 rounded-xl font-bold">+</button>
                                    </form>

                                    {/* List */}
                                    <div className="space-y-2">
                                        {(formData.deliverables || []).map(task => (
                                            <div key={task.id} className="flex items-center gap-3 p-3 bg-white dark:bg-gray-900 rounded-xl group">
                                                <button 
                                                    onClick={() => toggleTask(task.id)}
                                                    className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-transparent hover:border-green-500'}`}
                                                >
                                                    <i className="ph ph-check text-xs font-bold"></i>
                                                </button>
                                                <span className={`flex-1 text-sm font-medium ${task.completed ? 'text-gray-400 line-through' : 'text-gray-700 dark:text-gray-200'}`}>
                                                    {task.text}
                                                </span>
                                                <button onClick={() => deleteTask(task.id)} className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                                    <i className="ph ph-trash"></i>
                                                </button>
                                            </div>
                                        ))}
                                        {(formData.deliverables || []).length === 0 && (
                                            <div className="text-center py-8 text-gray-400 text-sm">
                                                No tasks yet. Keep track of what needs to be done!
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Summary */}
                                    {(formData.deliverables || []).length > 0 && (
                                        <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between text-xs font-bold text-gray-500">
                                            <span>{(formData.deliverables || []).filter(t => t.completed).length} completed</span>
                                            <span>{(formData.deliverables || []).length} total</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-5 border-t border-gray-100 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl flex gap-3">
                        {(onDelete || deleteTemplate) && <button onClick={handleDelete} className="px-6 py-4 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-2xl hover:bg-red-100 transition">Delete</button>}
                        {(onDuplicate || duplicateTemplate) && initialData.id && <button onClick={handleDuplicate} className="px-6 py-4 text-iosBlue font-bold bg-blue-50 dark:bg-blue-900/20 rounded-2xl hover:bg-blue-100 transition">Duplicate</button>}
                        <button onClick={handleSave} className="flex-1 bg-iosBlue text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20 hover:scale-[1.02] transition-transform">{isTemplate ? 'Save Template' : 'Save Content'}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
             // ... (User, Auth, Theme, Settings state)
             const [user, setUser] = React.useState(null);
            const [authChecked, setAuthChecked] = React.useState(false);
            const [darkMode, setDarkMode] = React.useState(false);
            const [appName, setAppName] = React.useState(() => localStorage.getItem('omniplan_app_name') || 'OmniPlan');
            const [isEditingAppName, setIsEditingAppName] = React.useState(false);
            const [isGuest, setIsGuest] = React.useState(() => !!localStorage.getItem('omniplan_items'));
            
            // Settings
            const [platforms, setPlatforms] = React.useState(INITIAL_PLATFORMS);
            const [statuses, setStatuses] = React.useState(INITIAL_STATUSES);
            const [pillars, setPillars] = React.useState(INITIAL_PILLARS);
            const [topics, setTopics] = React.useState(INITIAL_TOPICS);

            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);
            const [defaultView, setDefaultView] = React.useState(() => localStorage.getItem('omniplan_default_view') || 'month');

            // Data
            const [items, setItems] = React.useState([]); 
            const itemsRef = React.useRef(items); // Ref to track current items for sync
            const [events, setEvents] = React.useState([]); // New Events State
            const [templates, setTemplates] = React.useState([]); // NEW Template State
            const templatesRef = React.useRef(templates);
            
            const [projects, setProjects] = React.useState([{ id: 'default', name: 'My Brand' }]);
            const [activeProjectId, setActiveProjectId] = React.useState('default');
            
            // UI
            const [currentDate, setCurrentDate] = React.useState(new Date());
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [isTemplateModalOpen, setIsTemplateModalClientopen] = React.useState(false); // NEW Template Modal
            const [isEventModalOpen, setIsEventModalOpen] = React.useState(false); // New Event Modal State
            const [isBulkEditModalOpen, setIsBulkEditModalOpen] = React.useState(false); // NEW Bulk Edit Modal

            
            const [editingItem, setEditingItem] = React.useState(null);
            const [editingTemplate, setEditingTemplate] = React.useState(null); // NEW Template Editing State
            const [editingEvent, setEditingEvent] = React.useState(null); // New Event Editing State
            
            const [viewMode, setViewMode] = React.useState(defaultView); 
            const [draggedItem, setDraggedItem] = React.useState(null);
            const [draggedIsTemplate, setDraggedIsTemplate] = React.useState(false);
            
            const [searchQuery, setSearchQuery] = React.useState('');
            // Updated sortConfig to track two different sorting states
            const [sortConfig, setSortConfig] = React.useState({ 
                list: { key: null, direction: 'ascending' },
                status: { key: 'date', direction: 'ascending' } // Default sort for status view
            });
            const [showReminder, setShowReminder] = React.useState(false);

            // --- BULK SELECT STATE ---
            const [isBulkSelecting, setIsBulkSelecting] = React.useState(false);
            // Stores IDs as strings, prefixed with 'T:' for templates, 'I:' for items.
            const [selectedItemIds, setSelectedItemIds] = React.useState([]); 
            // --- END BULK SELECT STATE ---

            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setAuthChecked(true);
                    if (u) setIsGuest(false);
                });
                return () => unsubscribe();
            }, []);

            // Update refs whenever data changes
            React.useEffect(() => { itemsRef.current = items; }, [items]);
            React.useEffect(() => { templatesRef.current = templates; }, [templates]);

            React.useEffect(() => {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }

                // Load all data from localStorage
                const localItems = JSON.parse(localStorage.getItem('omniplan_items') || '[]');
                const localEvents = JSON.parse(localStorage.getItem('omniplan_events') || '[]');
                const localTemplates = JSON.parse(localStorage.getItem('omniplan_templates') || '[]');
                const localProjects = JSON.parse(localStorage.getItem('omniplan_projects') || '[{"id":"default","name":"My Brand"}]');
                const localPlatforms = JSON.parse(localStorage.getItem('omniplan_platforms') || 'null');
                const localStatuses = JSON.parse(localStorage.getItem('omniplan_statuses') || 'null');
                const localPillars = JSON.parse(localStorage.getItem('omniplan_pillars') || 'null');
                const localTopics = JSON.parse(localStorage.getItem('omniplan_topics') || 'null');
                
                if (localItems.length) setItems(localItems);
                if (localEvents.length) setEvents(localEvents);
                if (localTemplates.length) setTemplates(localTemplates);
                setProjects(localProjects);
                // Merge initial defaults with saved data, ensuring new defaults (like icons) are added if missing
                setPlatforms(localPlatforms ? {...INITIAL_PLATFORMS, ...localPlatforms} : INITIAL_PLATFORMS);
                setStatuses(localStatuses ? {...INITIAL_STATUSES, ...localStatuses} : INITIAL_STATUSES);
                setPillars(localPillars ? {...INITIAL_PILLARS, ...localPillars} : INITIAL_PILLARS);
                setTopics(localTopics ? {...INITIAL_TOPICS, ...localTopics} : INITIAL_TOPICS);

                const today = new Date().toISOString().split('T')[0];
                const todaysItems = localItems.filter(i => i.date === today);
                if(todaysItems.length > 0) setShowReminder(true);

                if (user) {
                    // Sync Items (excluding media fields from cloud data)
                    const unsubscribeItems = db.collection('users').doc(user.uid).collection('items')
                        .onSnapshot(snapshot => {
                            const cloudItems = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                            const currentLocalItems = JSON.parse(localStorage.getItem('omniplan_items') || '[]');
                            
                            // Merge cloud metadata with local media data
                            const mergedItems = cloudItems.map(cItem => {
                                const localMatch = currentLocalItems.find(l => l.id === cItem.id);
                                
                                // Preserve local media data if it exists
                                const image = localMatch?.image || null;
                                const video = localMatch?.video || null;
                                
                                return { ...cItem, image, video };
                            });
                            setItems(mergedItems);
                        });
                    
                    // Sync Events
                    const unsubscribeEvents = db.collection('users').doc(user.uid).collection('events')
                        .onSnapshot(snapshot => {
                            const cloudEvents = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                            setEvents(cloudEvents);
                        });

                    // Sync Templates (excluding media fields from cloud data)
                     const unsubscribeTemplates = db.collection('users').doc(user.uid).collection('templates')
                        .onSnapshot(snapshot => {
                            const cloudTemplates = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                            const currentLocalTemplates = JSON.parse(localStorage.getItem('omniplan_templates') || '[]');
                            
                            // Merge cloud metadata with local media data
                            const mergedTemplates = cloudTemplates.map(cTemplate => {
                                const localMatch = currentLocalTemplates.find(l => l.id === cTemplate.id);
                                
                                // Preserve local media data if it exists
                                const image = localMatch?.image || null;
                                const video = localMatch?.video || null;
                                
                                return { ...cTemplate, image, video };
                            });
                            setTemplates(mergedTemplates);
                        });

                    return () => { unsubscribeItems(); unsubscribeEvents(); unsubscribeTemplates(); };
                }
            }, [user]);

            // Save to localStorage
            React.useEffect(() => {
                try {
                    localStorage.setItem('omniplan_items', JSON.stringify(items));
                    localStorage.setItem('omniplan_events', JSON.stringify(events));
                    localStorage.setItem('omniplan_templates', JSON.stringify(templates)); // Save Templates
                    localStorage.setItem('omniplan_projects', JSON.stringify(projects));
                    localStorage.setItem('omniplan_platforms', JSON.stringify(platforms));
                    localStorage.setItem('omniplan_statuses', JSON.stringify(statuses));
                    localStorage.setItem('omniplan_pillars', JSON.stringify(pillars));
                    localStorage.setItem('omniplan_topics', JSON.stringify(topics));
                    localStorage.setItem('omniplan_app_name', appName);
                } catch (e) {
                    console.error("Storage quota exceeded or error saving to local storage", e);
                }
            }, [items, events, templates, projects, platforms, statuses, pillars, topics, appName]);

            const toggleTheme = () => {
                const newMode = !darkMode;
                setDarkMode(newMode);
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', newMode ? 'dark' : 'light');
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    setUser(null);
                    setIsGuest(false);
                    sessionStorage.removeItem('reminderShown');
                } catch (error) {
                    console.error("Error signing out: ", error);
                }
            };

            const handleAddProject = () => {
                const name = prompt("Enter new project name:");
                if (name && name.trim() !== "") {
                    const newProj = { id: generateId(), name: name.trim() };
                    const newProjects = [...projects, newProj];
                    setProjects(newProjects);
                    setActiveProjectId(newProj.id);
                }
            };

            const handleDeleteProject = () => {
                const projectToDelete = projects.find(p => p.id === activeProjectId);
                if (!projectToDelete) return;
                
                if (projects.length <= 1) {
                    // Use a custom modal or message instead of alert
                    console.log("Cannot delete: Must have at least one project.");
                    return;
                }

                if (confirm(`Delete project "${projectToDelete.name}" and all its content and templates?`)) {
                    const updatedItems = items.filter(item => item.projectId !== activeProjectId);
                    const updatedTemplates = templates.filter(template => template.projectId !== activeProjectId);

                    setItems(updatedItems);
                    setTemplates(updatedTemplates);

                    if (user) {
                        items.filter(item => item.projectId === activeProjectId).forEach(item => deleteItemFromCloud(item.id));
                        templates.filter(template => template.projectId === activeProjectId).forEach(template => deleteTemplateFromCloud(template.id));
                    }
                    const updatedProjects = projects.filter(p => p.id !== activeProjectId);
                    setProjects(updatedProjects);
                    setActiveProjectId(updatedProjects[0].id);
                }
            };

            // --- BULK SELECT HANDLERS ---
            const getItemPrefix = (isTemplate) => isTemplate ? 'T:' : 'I:';

            const handleLongPress = (id, isTemplate) => {
                const itemId = getItemPrefix(isTemplate) + id;
                setIsBulkSelecting(true);
                setSelectedItemIds(prev => {
                    // If not currently selected, select it and start bulk mode
                    if (!prev.includes(itemId)) {
                         return [itemId];
                    }
                    // If already selected, just stay in bulk mode (prevents unselecting on long-press)
                    return prev; 
                });
            };

            const handleToggleSelect = (id, isTemplate) => {
                const itemId = getItemPrefix(isTemplate) + id;
                setSelectedItemIds(prev => {
                    if (prev.includes(itemId)) {
                        const newSelected = prev.filter(i => i !== itemId);
                        // Exit bulk mode if last item is unselected
                        if (newSelected.length === 0) {
                            setIsBulkSelecting(false);
                        }
                        return newSelected;
                    } else {
                        return [...prev, itemId];
                    }
                });
            };

            const handleBulkDelete = () => {
                if (!selectedItemIds.length) return;
                
                if (!confirm(`Delete ${selectedItemIds.length} selected item(s)?`)) return;

                let updatedItems = [...items];
                let updatedTemplates = [...templates];

                selectedItemIds.forEach(itemId => {
                    const id = itemId.substring(2);
                    const isTemplate = itemId.startsWith('T:');

                    if (isTemplate) {
                        updatedTemplates = updatedTemplates.filter(t => t.id !== id);
                        deleteTemplateFromCloud(id);
                    } else {
                        updatedItems = updatedItems.filter(i => i.id !== id);
                        deleteItemFromCloud(id);
                    }
                });

                setItems(updatedItems);
                setTemplates(updatedTemplates);
                setSelectedItemIds([]);
                setIsBulkSelecting(false);
            };

            const handleBulkDragStart = (e, item, isTemplate) => {
                const itemId = getItemPrefix(isTemplate) + item.id;
                
                // If not in bulk select mode OR if the item is not selected, select it first
                if (isBulkSelecting && !selectedItemIds.includes(itemId)) {
                    setSelectedItemIds([itemId]); // Dragging a single non-selected item starts a single drag
                } else if (!isBulkSelecting) {
                     // Standard single drag
                    setDraggedItem(item);
                    setDraggedIsTemplate(isTemplate);
                    e.dataTransfer.setData('text/plain', item.id);
                    e.dataTransfer.setData('isTemplate', isTemplate);
                    e.dataTransfer.effectAllowed = isTemplate ? 'copy' : 'move';
                    return;
                }
                
                // If we reach here, we are dragging the selected set
                const selectedData = selectedItemIds.map(id => {
                    const idStr = id.substring(2);
                    const isT = id.startsWith('T:');
                    const data = isT ? templates.find(t => t.id === idStr) : items.find(i => i.id === idStr);
                    return { data, isTemplate: isT, id };
                }).filter(d => d.data); // Filter out any stale/missing data
                
                e.dataTransfer.setData('text/plain', JSON.stringify(selectedData.map(d => d.id)));
                e.dataTransfer.setData('isBulkDrag', 'true');
                e.dataTransfer.effectAllowed = 'copyMove';
                setDraggedItem(null); // Clear single drag item
            };
            
            const handleBulkDrop = (e, targetValue, type) => {
                e.preventDefault();
                
                const isBulkDrag = e.dataTransfer.getData('isBulkDrag') === 'true';
                
                if (isBulkDrag) {
                    const selectedIds = JSON.parse(e.dataTransfer.getData('text/plain') || '[]');
                    const targetDate = (type === 'date' && targetValue !== 'LIBRARY') ? targetValue : null;
                    const isLibraryDrop = (type === 'date' && targetValue === 'LIBRARY');
                    const targetStatus = type === 'status' ? targetValue : null;
                    
                    let newItems = [...items];
                    let newTemplates = [...templates];
                    
                    selectedIds.forEach(itemId => {
                        const id = itemId.substring(2);
                        const isTemplate = itemId.startsWith('T:');

                        if (isTemplate) {
                            const template = templates.find(t => t.id === id);
                            if (template && targetDate) {
                                // Dragging a template to a calendar date (COPY action)
                                const newId = generateId();
                                const copiedItem = {
                                    ...template,
                                    id: newId,
                                    date: targetDate,
                                    isTemplate: false,
                                    status: 'drafting',
                                    approvalStatus: 'Draft'
                                };
                                newItems.push(copiedItem);
                                saveItemToCloud(copiedItem.id, copiedItem);
                            }
                        } else {
                            // Dragging a content item (MOVE action)
                            newItems = newItems.map(item => {
                                if (item.id === id) {
                                    let updatedItem = { ...item };
                                    if (targetDate) {
                                        updatedItem.date = targetDate; // Calendar drop
                                    } else if (isLibraryDrop) {
                                        updatedItem.date = null; // Library drop
                                    } else if (targetStatus) {
                                        updatedItem.status = targetStatus; // Status drop
                                    }
                                    saveItemToCloud(updatedItem.id, updatedItem);
                                    return updatedItem;
                                }
                                return item;
                            });
                        }
                    });

                    setItems(newItems);
                    setTemplates(newTemplates);
                    setSelectedItemIds([]);
                    setIsBulkSelecting(false);
                    
                } else {
                    // Fallback to standard single drag logic
                    const id = e.dataTransfer.getData('text/plain');
                    const isTemplate = e.dataTransfer.getData('isTemplate') === 'true';
                    const item = (isTemplate ? templates : items).find(i => i.id === id);
                    if (item) {
                        setDraggedItem(item); // Restore dragged item state for standard handler
                        setDraggedIsTemplate(isTemplate);
                        handleDrop(e, targetValue, type);
                    }
                }
            };
            // --- END BULK SELECT HANDLERS ---
            
            // --- BULK EDIT HANDLER ---
            const handleUpdateBulk = (formData) => {
                let newItems = [...items];
                let newTemplates = [...templates];
                const fieldsToUpdate = {};
                
                if(formData.status) fieldsToUpdate.status = formData.status;
                if(formData.contentPillar) fieldsToUpdate.contentPillar = formData.contentPillar;
                if(formData.platform.length > 0) fieldsToUpdate.platform = formData.platform;
                if(formData.progress > 0) fieldsToUpdate.progress = formData.progress;

                selectedItemIds.forEach(itemId => {
                    const id = itemId.substring(2);
                    const isTemplate = itemId.startsWith('T:');

                    if (isTemplate) {
                        newTemplates = newTemplates.map(t => {
                            if (t.id === id) {
                                const updatedTemplate = { ...t, ...fieldsToUpdate };
                                saveTemplateToCloud(id, updatedTemplate);
                                return updatedTemplate;
                            }
                            return t;
                        });
                    } else {
                        newItems = newItems.map(i => {
                            if (i.id === id) {
                                const updatedItem = { ...i, ...fieldsToUpdate };
                                saveItemToCloud(id, updatedItem);
                                return updatedItem;
                            }
                            return i;
                        });
                    }
                });

                setItems(newItems);
                setTemplates(newTemplates);
                setIsBulkEditModalOpen(false);
                setSelectedItemIds([]);
                setIsBulkSelecting(false);
            };
            // --- END BULK EDIT HANDLER ---


            // ... (Drag & Drop logic)
             const getMonthData = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay, year, month };
            };

            const handleDragStart = (e, item, isTemplate) => {
                setDraggedItem(item);
                setDraggedIsTemplate(isTemplate);
                e.dataTransfer.setData('text/plain', item.id);
                e.dataTransfer.setData('isTemplate', isTemplate);
                // When dragging a template, set the effect to 'copy' so it leaves a template behind
                if (isTemplate) {
                    e.dataTransfer.effectAllowed = 'copy';
                } else {
                    e.dataTransfer.effectAllowed = 'move';
                }
            };
            
            const handleDragOver = (e) => { 
                e.preventDefault(); 
                const isBulkDrag = e.dataTransfer.getData('isBulkDrag') === 'true';
                if (isBulkDrag) {
                     e.dataTransfer.dropEffect = 'copy'; // Always copy for bulk, user can decide to delete originals later
                } else {
                     e.dataTransfer.dropEffect = draggedIsTemplate ? 'copy' : 'move'; 
                }
            };

            const handleCreateItemFromTemplate = (template, targetDate) => {
                const newId = generateId();
                const copiedItem = {
                    ...template,
                    id: newId,
                    date: targetDate,
                    isTemplate: false, // FIX: Explicitly set isTemplate to false for the new content item
                    status: 'drafting', // Start status for new content
                    approvalStatus: 'Draft' 
                };
                
                const newItems = [...items, copiedItem];
                itemsRef.current = newItems;
                setItems(newItems);
                saveItemToCloud(copiedItem.id, copiedItem);
                setDraggedItem(null);
            }

            // Standard single item drop
            const handleDrop = (e, targetValue, type = 'date') => { 
                e.preventDefault();
                if (!draggedItem) return;

                const isDropOnCalendar = (targetValue !== 'LIBRARY' && type === 'date');
                
                if (draggedIsTemplate && isDropOnCalendar) {
                    // Action: Dragging a Template to Calendar (copy to items)
                    handleCreateItemFromTemplate(draggedItem, targetValue);
                } else if (!draggedIsTemplate) {
                    // Action: Dragging a regular Content Item
                    if (isDropOnCalendar) {
                        // Dragging from Library (date: null) to Calendar (set date) or Calendar to Calendar (change date)
                        const updatedItems = items.map(item => {
                            if (item.id === draggedItem.id) {
                                const updatedItem = { ...item, date: targetValue };
                                saveItemToCloud(updatedItem.id, updatedItem);
                                return updatedItem;
                            }
                            return item;
                        });
                        setItems(updatedItems);
                    } else if (targetValue === 'LIBRARY' && type === 'date') {
                        // Dragging from Calendar to Library (set date: null)
                        const updatedItems = items.map(item => {
                            if (item.id === draggedItem.id) {
                                const updatedItem = { ...item, date: null };
                                saveItemToCloud(updatedItem.id, updatedItem);
                                return updatedItem;
                            }
                            return item;
                        });
                        setItems(updatedItems);
                    } else if (type === 'status') {
                         // Dragging to Status View (update status)
                         const updatedItems = items.map(item => {
                            if (item.id === draggedItem.id) {
                                const updatedItem = { ...item, status: targetValue };
                                saveItemToCloud(updatedItem.id, updatedItem);
                                return updatedItem;
                            }
                            return item;
                        });
                        setItems(updatedItems);
                    }
                }
                
                setDraggedItem(null);
                setDraggedIsTemplate(false);
            };

            // --- Cloud Saving functions ---
            const saveItemToCloud = (id, data) => {
                if (!user) return;
                const cloudPayload = { ...data };
                // REMOVE large media fields before saving to cloud
                delete cloudPayload.image;
                delete cloudPayload.video;

                db.collection('users').doc(user.uid).collection('items').doc(id).set(cloudPayload, { merge: true });
            };

            const deleteItemFromCloud = (id) => {
                if(!user) return;
                db.collection('users').doc(user.uid).collection('items').doc(id).delete();
            }

            const saveTemplateToCloud = (id, data) => {
                if (!user) return;
                const cloudPayload = { ...data };
                // REMOVE large media fields before saving to cloud
                delete cloudPayload.image;
                delete cloudPayload.video;
                
                db.collection('users').doc(user.uid).collection('templates').doc(id).set(cloudPayload, { merge: true });
            };

            const deleteTemplateFromCloud = (id) => {
                if(!user) return;
                db.collection('users').doc(user.uid).collection('templates').doc(id).delete();
            }

            // --- Event Logic ---
            const saveEventToCloud = (id, data) => {
                if (!user) return;
                db.collection('users').doc(user.uid).collection('events').doc(id).set(data, { merge: true });
            };

            const deleteEventFromCloud = (id) => {
                if (!user) return;
                db.collection('users').doc(user.uid).collection('events').doc(id).delete();
            };

            const handleSaveEvent = (eventData) => {
                let newEvents;
                if (editingEvent?.id) {
                    newEvents = events.map(e => e.id === editingEvent.id ? { ...eventData, id: e.id } : e);
                    saveEventToCloud(editingEvent.id, eventData);
                } else {
                    const newEvent = { ...eventData, id: generateId() };
                    newEvents = [...events, newEvent];
                    saveEventToCloud(newEvent.id, newEvent);
                }
                setEvents(newEvents);
                setIsEventModalOpen(false);
                setEditingEvent(null);
            };

            const handleDeleteEvent = (id) => {
                if (confirm('Delete this event?')) {
                    setEvents(events.filter(e => e.id !== id));
                    deleteEventFromCloud(id);
                    setIsEventModalOpen(false);
                    setEditingEvent(null);
                }
            };
            
            // --- Template Logic ---
            const handleSaveTemplate = (templateData) => {
                let newTemplates;
                if (editingTemplate?.id) {
                    newTemplates = templates.map(t => t.id === editingTemplate.id ? { ...templateData, id: t.id } : t);
                    saveTemplateToCloud(editingTemplate.id, templateData);
                } else {
                    const newTemplate = { 
                        ...templateData, 
                        id: generateId(), 
                        projectId: activeProjectId, 
                        isTemplate: true // Mark clearly
                    };
                    newTemplates = [...templates, newTemplate];
                    saveTemplateToCloud(newTemplate.id, newTemplate);
                }
                templatesRef.current = newTemplates;
                setTemplates(newTemplates);
                setIsTemplateModalClientopen(false);
                setEditingTemplate(null);
            };

            const handleDeleteTemplate = (id) => {
                 if (confirm('Delete this template?')) {
                    setTemplates(templates.filter(t => t.id !== id));
                    deleteTemplateFromCloud(id);
                    setIsTemplateModalClientopen(false);
                    setEditingTemplate(null);
                }
            };
            
            const handleDuplicateTemplate = (templateData) => {
                const newTemplate = {
                    ...templateData,
                    id: generateId(),
                    title: `Copy of ${templateData.title}`,
                    isTemplate: true
                };
                const newTemplates = [...templates, newTemplate];
                setTemplates(newTemplates);
                saveTemplateToCloud(newTemplate.id, newTemplate);
                setIsTemplateModalClientopen(false);
            };

            // --- Content Item Logic ---
            const handleInlineUpdate = (id, field, value) => {
                const updatedItems = items.map(item => {
                    if (item.id === id) {
                        const updatedItem = { ...item, [field]: value };
                        if (field !== 'title' && field !== 'caption') {
                            saveItemToCloud(id, updatedItem);
                        }
                        return updatedItem;
                    }
                    return item;
                });
                setItems(updatedItems);
            };

            const handleInlineBlur = (item) => {
                saveItemToCloud(item.id, item);
            };

            const handleSaveItem = (itemData) => {
                let newItems;
                if (editingItem) {
                    newItems = items.map(i => i.id === editingItem.id ? { ...itemData, id: i.id } : i);
                    saveItemToCloud(editingItem.id, itemData);
                } else {
                    // New item: defaults to the Library (date: null) for easy templating, 
                    // unless a date was pre-set (e.g., via calendar cell '+' button)
                    const newItem = { 
                        ...itemData, 
                        id: generateId(), 
                        projectId: activeProjectId,
                        date: itemData.date || null, // Ensure date is null if not explicitly set
                        status: itemData.status || Object.keys(statuses)[0] 
                    };
                    newItems = [...items, newItem];
                    saveItemToCloud(newItem.id, newItem);
                }
                
                itemsRef.current = newItems;
                setItems(newItems);
                setIsModalOpen(false);
                setEditingItem(null);
            };

            const handleDeleteItem = (id) => {
                if (confirm('Delete this content?')) {
                    setItems(items.filter(i => i.id !== id));
                    deleteItemFromCloud(id);
                    setIsModalOpen(false);
                }
            };

            const handleDuplicateItem = (itemData) => {
                const newItem = {
                    ...itemData,
                    id: generateId(),
                    title: `Copy of ${itemData.title}`,
                    status: 'drafting', // Reset status to drafting
                    approvalStatus: 'Draft',
                    date: null // New duplicates go to the Library by default
                };
                const newItems = [...items, newItem];
                setItems(newItems);
                saveItemToCloud(newItem.id, newItem);
                setIsModalOpen(false);
            };
            
            const handleAddRow = () => {
                const newItem = { 
                    id: generateId(), 
                    projectId: activeProjectId, 
                    title: '', 
                    caption: '',
                    status: Object.keys(statuses)[0], 
                    platform: [], // FIX: New item starts with empty platform array
                    date: null // New items created in list view also go to Library
                };
                setItems([...items, newItem]);
                saveItemToCloud(newItem.id, newItem);
            };

            const requestSort = (key, view) => {
                const currentConfig = sortConfig[view];
                let direction = 'ascending';
                if (currentConfig.key === key && currentConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig(prev => ({ ...prev, [view]: { key, direction } }));
            };

            // --- Multi-Day & Recurrence Helper Logic ---
            const checkRecurrence = (startDate, duration, targetDate, recurrence, interval) => {
                const timeDiff = targetDate.getTime() - startDate.getTime();
                if (timeDiff < 0) return false;

                const msPerDay = 1000 * 60 * 60 * 24;
                // Calculate which recurrence instance cycle we are potentially in
                let instanceStartTimestamp = startDate.getTime();
                
                if (!recurrence || recurrence === 'none') return false;

                let cycleDays = 0;
                if (recurrence === 'daily') cycleDays = 1;
                else if (recurrence === 'weekly') cycleDays = 7;
                else if (recurrence === 'biweekly') cycleDays = 14;
                else if (recurrence === 'every_x_days') cycleDays = parseInt(interval || 1);
                
                if (cycleDays > 0) {
                     const diffDays = Math.floor(timeDiff / msPerDay);
                     const cycles = Math.floor(diffDays / cycleDays);
                     const cycleStartDate = new Date(startDate.getTime() + (cycles * cycleDays * msPerDay));
                     
                     // Check if target is within [cycleStartDate, cycleStartDate + duration]
                     if (targetDate.getTime() >= cycleStartDate.getTime() && 
                         targetDate.getTime() <= (cycleStartDate.getTime() + duration)) {
                         return true;
                     }
                } else if (recurrence === 'monthly' || recurrence === 'quarterly' || recurrence === 'yearly') {
                     const mDiff = (targetDate.getMonth() - startDate.getMonth()) + (12 * (targetDate.getFullYear() - startDate.getFullYear()));
                     let isFrequencyMatch = false;
                     
                     if (recurrence === 'monthly') isFrequencyMatch = true; // Every month is a candidate
                     if (recurrence === 'quarterly') isFrequencyMatch = (mDiff % 3 === 0);
                     if (recurrence === 'yearly') isFrequencyMatch = (mDiff % 12 === 0);

                     if (isFrequencyMatch) {
                        const candidateStart = new Date(startDate);
                        candidateStart.setFullYear(targetDate.getFullYear(), targetDate.getMonth());
                        if (candidateStart.getDate() === startDate.getDate()) {
                             if (targetDate.getTime() >= candidateStart.getTime() && 
                                 targetDate.getTime() <= (candidateStart.getTime() + duration)) {
                                 return true;
                             }
                        }
                     }
                }
                return false;
            }

            const getItemsForDate = (dateStr, itemsList, isEvent = false) => {
                const targetDate = new Date(dateStr);
                targetDate.setHours(0,0,0,0);

                return itemsList.filter(item => {
                    if (!item.date) return false;
                    const startDate = new Date(item.date);
                    const endDate = item.endDate ? new Date(item.endDate) : new Date(item.date);
                    startDate.setHours(0,0,0,0);
                    endDate.setHours(0,0,0,0);
                    const duration = endDate.getTime() - startDate.getTime();

                    // 1. Regular Check
                    if ((!item.recurrence || item.recurrence === 'none')) {
                         return targetDate.getTime() >= startDate.getTime() && targetDate.getTime() <= endDate.getTime();
                    }
                    
                    // 2. Recurrence Check
                    return checkRecurrence(startDate, duration, targetDate, item.recurrence, item.recurrenceInterval);
                });
            }

            const currentMonthData = getMonthData(currentDate);
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const processedItems = items
                .filter(i => i.projectId === activeProjectId)
                .filter(item => {
                    if (!searchQuery) return true;
                    const q = searchQuery.toLowerCase();
                    const pIds = Array.isArray(item.platform) ? item.platform : [item.platform];
                    const platformLabels = pIds.map(pid => platforms[pid]?.label?.toLowerCase() || '').join(' ');
                    const statusName = statuses[item.status]?.label?.toLowerCase() || '';
                    return (
                        (item.title && item.title.toLowerCase().includes(q)) ||
                        (item.caption && item.caption.toLowerCase().includes(q)) ||
                        platformLabels.includes(q) ||
                        statusName.includes(q)
                    );
                });

            const processedTemplates = templates
                .filter(t => t.projectId === activeProjectId)
                .filter(template => {
                    if (!searchQuery) return true;
                    const q = searchQuery.toLowerCase();
                    const pIds = Array.isArray(template.platform) ? template.platform : [template.platform];
                    const platformLabels = pIds.map(pid => platforms[pid]?.label?.toLowerCase() || '').join(' ');
                    const statusName = statuses[template.status]?.label?.toLowerCase() || '';
                    return (
                        (template.title && template.title.toLowerCase().includes(q)) ||
                        (template.caption && template.caption.toLowerCase().includes(q)) ||
                        platformLabels.includes(q) ||
                        statusName.includes(q)
                    );
                });
            
            const allLibraryContent = processedItems.filter(i => !i.date).concat(processedTemplates);

            const getSortedItems = (itemsList, viewKey) => {
                const config = sortConfig[viewKey];
                if (!config.key) return itemsList;
                
                let sortableItems = [...itemsList];
                sortableItems.sort((a, b) => {
                    let aVal = a[config.key] || '';
                    let bVal = b[config.key] || '';
                    
                    if (config.key === 'platform') {
                            const aP = Array.isArray(a.platform) ? a.platform[0] : a.platform;
                            const bP = Array.isArray(b.platform) ? b.platform[0] : b.platform;
                            aVal = platforms[aP]?.label || '';
                            bVal = platforms[bP]?.label || '';
                    }
                    if (config.key === 'status') aVal = statuses[a.status]?.label || '';
                    if (config.key === 'status') bVal = statuses[b.status]?.label || '';
                    if (config.key === 'progress') {
                            aVal = a.progress || 0;
                            bVal = b.progress || 0;
                            return config.direction === 'ascending' ? aVal - bVal : bVal - aVal;
                    }
                    if (config.key === 'date') {
                        // Treat null dates (Library items) as last
                        if (a.date === null && b.date === null) return 0;
                        if (a.date === null) return 1;
                        if (b.date === null) return -1;
                        
                        aVal = new Date(a.date).getTime();
                        bVal = new Date(b.date).getTime();
                        return config.direction === 'ascending' ? aVal - bVal : bVal - aVal;
                    }


                    if (aVal < bVal) return config.direction === 'ascending' ? -1 : 1;
                    if (aVal > bVal) return config.direction === 'ascending' ? 1 : -1;
                    return 0;
                });
                return sortableItems;
            }

            const sortedListItems = React.useMemo(() => getSortedItems(processedItems, 'list'), [processedItems, sortConfig.list]);

            const renderCalendarView = () => (
                <div className="flex-1 overflow-y-auto p-6 bg-[#F2F2F7] dark:bg-black">
                     <div className="grid grid-cols-7 mb-4">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="text-center text-xs font-bold text-gray-400 uppercase tracking-wide">{day}</div>
                        ))}
                    </div>
                    <div className="grid grid-cols-7 gap-4 min-h-[600px] pb-20">
                        {Array.from({ length: currentMonthData.firstDay }).map((_, i) => <div key={`empty-${i}`}></div>)}
                        {Array.from({ length: currentMonthData.days }).map((_, i) => {
                            const dayNum = i + 1;
                            const dateStr = `${currentMonthData.year}-${String(currentMonthData.month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                            
                            const daysItems = getItemsForDate(dateStr, processedItems);
                            const daysEvents = getItemsForDate(dateStr, events, true);
                            
                            const isToday = new Date().toDateString() === new Date(currentMonthData.year, currentMonthData.month, dayNum).toDateString();

                            return (
                                <div 
                                    key={dayNum} 
                                    className={`bg-white dark:bg-[#1C1C1E] rounded-3xl p-3 min-h-[140px] shadow-sm flex flex-col gap-2 transition-all hover:shadow-ios ${isToday ? 'ring-2 ring-iosBlue' : ''}`}
                                    onDragOver={handleDragOver}
                                    onDrop={(e) => handleBulkDrop(e, dateStr, 'date')}
                                >
                                    <div className="flex justify-between items-center px-1">
                                        <span className={`text-sm font-bold w-8 h-8 flex items-center justify-center rounded-full ${isToday ? 'bg-iosBlue text-white' : 'text-gray-700 dark:text-gray-200'}`}>{dayNum}</span>
                                        <div className="flex gap-1">
                                            {/* Event color indicator (small circle) */}
                                            {daysEvents.map(ev => (
                                                 <div 
                                                    key={ev.id} 
                                                    className={`w-3 h-3 rounded-full mt-2 cursor-pointer ${ev.color.split(' ')[0]} shadow-sm`}
                                                    title={ev.title}
                                                    onClick={() => { setEditingEvent(ev); setIsEventModalOpen(true); }}
                                                 ></div>
                                            ))}
                                            <button className="text-gray-300 hover:text-iosBlue transition" title="Add Content" onClick={() => { setEditingItem({ date: dateStr, projectId: activeProjectId, platform: [], status: 'idea' }); setIsModalOpen(true); }}><i className="ph ph-plus text-lg"></i></button>
                                        </div>
                                    </div>
                                    
                                    {/* Events List (simplified in calendar view to only show color dot) */}
                                    <div className="flex flex-col gap-1">
                                    </div>

                                    <div className="flex-1 space-y-2">
                                        {daysItems.map(item => {
                                             const d = new Date(dateStr); d.setHours(0,0,0,0);
                                             const start = new Date(item.date); start.setHours(0,0,0,0);
                                             const end = item.endDate ? new Date(item.endDate) : new Date(item.date); end.setHours(0,0,0,0);
                                             
                                             let isStart = (d.getTime() === start.getTime());
                                             let isEnd = (d.getTime() === end.getTime());
                                             let isMiddle = (d.getTime() > start.getTime() && d.getTime() < end.getTime());
                                             
                                             if (item.recurrence && item.recurrence !== 'none') {
                                                 isStart = false; isEnd = false; isMiddle = false; 
                                             }

                                            return (
                                                <DraggableCard 
                                                    key={item.id} 
                                                    item={item} 
                                                    onDragStart={handleBulkDragStart} // Use bulk drag handler
                                                    onClick={(id) => { setEditingItem(item); setIsModalOpen(true); }} 
                                                    onLongPress={(id) => handleLongPress(id, false)}
                                                    onToggleSelect={(id) => handleToggleSelect(id, false)}
                                                    isBulkSelecting={isBulkSelecting}
                                                    isSelected={selectedItemIds.includes('I:' + item.id)}
                                                    mini={true} 
                                                    platforms={platforms} 
                                                    statuses={statuses} 
                                                    pillars={pillars}
                                                    isMultiDayStart={isStart}
                                                    isMultiDayEnd={isEnd}
                                                    isMultiDayMiddle={isMiddle}
                                                />
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            // ... (renderStatusView, renderListView)
            const renderStatusView = () => {
                const currentSort = sortConfig.status;
                const getSortIndicator = (key) => {
                    if (currentSort.key !== key) return null;
                    return currentSort.direction === 'ascending' ? 'â–²' : 'â–¼';
                };
                
                return (
                    <div className="flex-1 overflow-x-auto p-6 bg-[#F2F2F7] dark:bg-black">
                        <div className="flex gap-6 h-full min-h-[600px] pb-20">
                            {Object.values(statuses).map(status => {
                                const statusItems = processedItems.filter(item => item.status === status.id);
                                const sortedStatusItems = getSortedItems(statusItems, 'status');
                                
                                return (
                                    <div key={status.id} className="flex-1 min-w-[300px] bg-white/50 dark:bg-gray-900/50 rounded-3xl border border-gray-200 dark:border-gray-800 flex flex-col h-full backdrop-blur-sm" onDragOver={handleDragOver} onDrop={(e) => handleBulkDrop(e, status.id, 'status')}>
                                        <div className="p-4 flex justify-between items-center border-b border-gray-100 dark:border-gray-800">
                                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${status.color} flex items-center gap-2`}>
                                                <i className={`ph ${status.icon}`}></i> {status.label}
                                            </span>
                                            <span className="text-xs bg-white dark:bg-gray-700 px-2 py-1 rounded-full font-bold text-gray-500">{statusItems.length}</span>
                                        </div>
                                        {/* Sort Control for Status View */}
                                        <div className="px-4 pt-2 flex items-center gap-4 text-xs font-bold text-gray-400 uppercase">
                                            <span className="text-[10px] font-medium">Sort By:</span>
                                            <button 
                                                onClick={() => requestSort('date', 'status')}
                                                className={`cursor-pointer hover:text-iosBlue transition ${currentSort.key === 'date' ? 'text-iosBlue' : ''}`}
                                            >
                                                Date {getSortIndicator('date')}
                                            </button>
                                            <button 
                                                onClick={() => requestSort('title', 'status')}
                                                className={`cursor-pointer hover:text-iosBlue transition ${currentSort.key === 'title' ? 'text-iosBlue' : ''}`}
                                            >
                                                Title {getSortIndicator('title')}
                                            </button>
                                        </div>
                                        <div className="flex-1 p-4 space-y-3 overflow-y-auto">
                                            {sortedStatusItems.map(item => (
                                                <DraggableCard 
                                                    key={item.id} 
                                                    item={item} 
                                                    onDragStart={handleBulkDragStart} 
                                                    onClick={(id) => { setEditingItem(item); setIsModalOpen(true); }}
                                                    onLongPress={(id) => handleLongPress(id, false)}
                                                    onToggleSelect={(id) => handleToggleSelect(id, false)}
                                                    isBulkSelecting={isBulkSelecting}
                                                    isSelected={selectedItemIds.includes('I:' + item.id)}
                                                    platforms={platforms} 
                                                    statuses={statuses} 
                                                    pillars={pillars}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const renderListView = () => {
                const getRowColor = (progress) => {
                    if (!progress) return 'bg-transparent hover:bg-gray-50 dark:hover:bg-gray-800/50';
                    if (progress < 25) return 'bg-red-50/50 hover:bg-red-50 dark:bg-red-900/10 dark:hover:bg-red-900/20';
                    if (progress < 50) return 'bg-orange-50/50 hover:bg-orange-50 dark:bg-orange-900/10 dark:hover:bg-orange-900/20';
                    if (progress < 75) return 'bg-yellow-50/50 hover:bg-yellow-50 dark:bg-yellow-900/10 dark:hover:bg-yellow-900/20';
                    return 'bg-green-50/50 hover:bg-green-50 dark:bg-green-900/10 dark:hover:bg-green-900/20';
                };

                const currentSort = sortConfig.list;

                return (
                    <div className="flex-1 overflow-y-auto p-6 bg-[#F2F2F7] dark:bg-black">
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-3xl shadow-sm overflow-hidden flex flex-col h-full max-h-[calc(100vh-180px)]">
                             <div className="overflow-y-auto flex-1">
                                <table className="w-full text-left border-collapse">
                                    <thead className="sticky top-0 bg-white dark:bg-[#1C1C1E] z-10 shadow-sm">
                                        <tr className="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-100 dark:border-gray-800">
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-20">Media</th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider cursor-pointer hover:text-iosBlue transition" onClick={() => requestSort('title', 'list')}>
                                                Title / Details {currentSort.key === 'title' && (currentSort.direction === 'ascending' ? 'â–²' : 'â–¼')}
                                            </th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-32">Pillar</th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-32 cursor-pointer hover:text-iosBlue transition" onClick={() => requestSort('platform', 'list')}>
                                                Platforms {currentSort.key === 'platform' && (currentSort.direction === 'ascending' ? 'â–²' : 'â–¼')}
                                            </th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-32 cursor-pointer hover:text-iosBlue transition" onClick={() => requestSort('status', 'list')}>
                                                Status {currentSort.key === 'status' && (currentSort.direction === 'ascending' ? 'â–²' : 'â–¼')}
                                            </th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-32 cursor-pointer hover:text-iosBlue transition" onClick={() => requestSort('progress', 'list')}>
                                                Progress {currentSort.key === 'progress' && (currentSort.direction === 'ascending' ? 'â–²' : 'â–¼')}
                                            </th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-32 cursor-pointer hover:text-iosBlue transition" onClick={() => requestSort('date', 'list')}>
                                                Date {currentSort.key === 'date' && (currentSort.direction === 'ascending' ? 'â–²' : 'â–¼')}
                                            </th>
                                            <th className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider w-12"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedListItems.map(item => {
                                            const pillar = pillars[item.contentPillar] || pillars.other;
                                            return (
                                                <tr 
                                                    key={item.id} 
                                                    className={`border-b border-gray-100 dark:border-gray-800 transition group last:border-0 ${getRowColor(item.progress)}`}
                                                >
                                                    <td className="p-3">
                                                        <div 
                                                            className="w-12 h-12 rounded-xl bg-white dark:bg-gray-800 overflow-hidden flex items-center justify-center cursor-pointer shadow-sm border border-gray-100 dark:border-gray-700"
                                                            onClick={() => { setEditingItem(item); setIsModalOpen(true); }}
                                                        >
                                                            {item.image ? <img src={item.image} className="w-full h-full object-cover" /> : 
                                                            item.video ? <div className="bg-black w-full h-full flex items-center justify-center"><i className="ph ph-play-circle text-white text-xl"></i></div> :
                                                            <i className="ph ph-image text-gray-300 text-xl"></i>}
                                                        </div>
                                                    </td>
                                                    <td className="p-3">
                                                        <input 
                                                            type="text" 
                                                            className="w-full bg-transparent font-semibold text-gray-900 dark:text-white outline-none border-b border-transparent focus:border-iosBlue mb-1"
                                                            value={item.title}
                                                            onChange={(e) => handleInlineUpdate(item.id, 'title', e.target.value)}
                                                            onBlur={() => handleInlineBlur(item)}
                                                            placeholder="Untitled"
                                                        />
                                                        <input 
                                                            type="text" 
                                                            className="w-full bg-transparent text-xs text-gray-400 outline-none border-b border-transparent focus:border-iosBlue"
                                                            value={item.caption || ''}
                                                            onChange={(e) => handleInlineUpdate(item.id, 'caption', e.target.value)}
                                                            onBlur={() => handleInlineBlur(item)}
                                                            placeholder="No details..."
                                                        />
                                                    </td>
                                                    <td className="p-3">
                                                        <span title={pillar.label} className={`text-sm font-semibold flex items-center gap-2 ${pillar.color.includes('text-') ? pillar.color.split(' ').find(c => c.startsWith('text-')) : 'text-gray-700 dark:text-gray-200'}`}>
                                                            <i className={`ph ${pillar.icon}`}></i> {pillar.label}
                                                        </span>
                                                    </td>
                                                    <td className="p-3">
                                                         <div className="flex -space-x-2 py-1 pl-1 cursor-pointer" onClick={() => { setEditingItem(item); setIsModalOpen(true); }}>
                                                            {(Array.isArray(item.platform) ? item.platform : [item.platform]).map(pid => {
                                                                const p = platforms[pid];
                                                                if (!p) return null; // FIX: Skip if platform ID is invalid/stale
                                                                return (
                                                                     <div key={pid} className={`w-8 h-8 rounded-full flex items-center justify-center text-white shadow-sm ring-2 ring-white dark:ring-[#1C1C1E] ${p.color}`}>
                                                                        <i className={`ph ${p.icon} text-sm`}></i>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </td>
                                                    <td className="p-3">
                                                        <select 
                                                            className="w-full bg-transparent text-sm font-bold outline-none cursor-pointer"
                                                            style={{color: statuses[item.status]?.color?.includes('text-') ? '' : '#6366f1'}} 
                                                            value={item.status}
                                                            onChange={(e) => handleInlineUpdate(item.id, 'status', e.target.value)}
                                                        >
                                                            {Object.values(statuses).map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                                        </select>
                                                    </td>
                                                    <td className="p-3">
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex-1 bg-gray-200 dark:bg-gray-700 h-1.5 rounded-full overflow-hidden">
                                                                <div className="bg-iosBlue h-full rounded-full" style={{width: `${item.progress || 0}%`}}></div>
                                                            </div>
                                                            <span className="text-xs font-bold text-gray-500">{item.progress || 0}%</span>
                                                        </div>
                                                    </td>
                                                    <td className="p-3">
                                                        <input 
                                                            type="date" 
                                                            className="bg-transparent text-sm text-gray-500 font-medium outline-none"
                                                            value={item.date || ''}
                                                            onChange={(e) => handleInlineUpdate(item.id, 'date', e.target.value)}
                                                        />
                                                    </td>
                                                    <td className="p-3 text-right">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); handleDeleteItem(item.id); }}
                                                            className="p-2 text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100"
                                                        >
                                                            <i className="ph ph-trash text-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                        {sortedListItems.length === 0 && (
                                            <tr>
                                                <td colSpan="8" className="p-8 text-center text-gray-400 text-sm">No items match your search.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <button 
                                onClick={handleAddRow}
                                className="w-full py-3 bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-800 text-iosBlue font-semibold text-sm border-t border-gray-100 dark:border-gray-700 transition"
                            >
                                + Add Row
                            </button>
                        </div>
                    </div>
                );
            };

            if (!authChecked) return <div className="flex items-center justify-center h-screen bg-[#F2F2F7] dark:bg-black"><div className="w-8 h-8 border-4 border-iosBlue border-t-transparent rounded-full animate-spin"></div></div>;
            if (!user && !isGuest) return <AuthScreen onLogin={(u) => { if(u) setUser(u); else setIsGuest(true); }} />;

            return (
                <div className={`flex h-screen overflow-hidden ${darkMode ? 'dark' : ''}`}>
                    {/* Sidebar */}
                    <div className="w-80 flex-shrink-0 flex flex-col bg-white dark:bg-[#1C1C1E] border-r border-gray-100 dark:border-gray-800 z-20">
                        <div className="p-6">
                            <div className="flex items-center gap-2 mb-6 group">
                                <span className="text-iosBlue text-2xl"><i className="ph ph-calendar-check-fill"></i></span>
                                {isEditingAppName ? (
                                    <input 
                                        type="text" 
                                        autoFocus
                                        className="text-2xl font-bold tracking-tight text-black dark:text-white bg-transparent border-b-2 border-iosBlue outline-none w-full"
                                        value={appName}
                                        onChange={(e) => setAppName(e.target.value)}
                                        onBlur={() => setIsEditingAppName(false)}
                                        onKeyDown={(e) => e.key === 'Enter' && setIsEditingAppName(false)}
                                    />
                                ) : (
                                    <h1 
                                        onClick={() => setIsEditingAppName(true)}
                                        className="text-2xl font-bold tracking-tight text-black dark:text-white cursor-pointer hover:opacity-70 flex items-center gap-2"
                                        title="Click to rename"
                                    >
                                        {appName}
                                        <i className="ph ph-pencil-simple text-sm text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                    </h1>
                                )}
                            </div>

                            <div className="mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Current Project</span>
                                    <div className="flex gap-2">
                                        {projects.length > 1 && (
                                            <button 
                                                onClick={handleDeleteProject} 
                                                className="text-[10px] font-bold text-red-400 hover:text-red-500 uppercase tracking-wider transition-colors"
                                                title="Delete current project"
                                            >
                                                Delete
                                            </button>
                                        )}
                                        <button onClick={handleAddProject} className="text-xs font-semibold text-iosBlue hover:text-blue-600 transition-colors">+ New</button>
                                    </div>
                                </div>
                                <div className="relative">
                                    <select value={activeProjectId} onChange={(e) => setActiveProjectId(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl text-sm font-medium outline-none appearance-none cursor-pointer">
                                        {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                    <i className="ph ph-caret-down absolute right-3 top-3.5 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        {/* Library Section */}
                        <div className="flex-1 overflow-y-auto px-6 pb-4" onDragOver={handleDragOver} onDrop={(e) => handleBulkDrop(e, 'LIBRARY', 'date')}>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-sm font-bold text-gray-400 uppercase tracking-wider">Library</h2>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => { setEditingTemplate({projectId: activeProjectId, platform: [], status: 'idea', date: null, isTemplate: true}); setIsTemplateModalClientopen(true); }} 
                                        className="w-8 h-8 bg-yellow-400 text-white rounded-full flex items-center justify-center shadow-lg shadow-yellow-500/30 hover:scale-105 transition"
                                        title="New Template"
                                    >
                                        <i className="ph ph-copy simple text-lg"></i>
                                    </button>
                                    <button onClick={() => { setEditingItem({projectId: activeProjectId, platform: [], status: 'idea', date: null}); setIsModalOpen(true); }} className="w-8 h-8 bg-iosBlue text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30 hover:scale-105 transition"><i className="ph ph-plus"></i></button>
                                </div>
                            </div>
                            <div className="space-y-3 min-h-[100px]">
                                {/* Templates (always at the top) */}
                                {processedTemplates.map(template => (
                                    <DraggableCard 
                                        key={template.id} 
                                        item={template} 
                                        onDragStart={handleBulkDragStart} 
                                        onClick={(id) => { setEditingTemplate(template); setIsTemplateModalClientopen(true); }} 
                                        onLongPress={(id) => handleLongPress(id, true)}
                                        onToggleSelect={(id) => handleToggleSelect(id, true)}
                                        isBulkSelecting={isBulkSelecting}
                                        isSelected={selectedItemIds.includes('T:' + template.id)}
                                        platforms={platforms} 
                                        statuses={statuses} 
                                        pillars={pillars}
                                        isTemplate={true}
                                    />
                                ))}

                                {/* Regular Library Content */}
                                {processedItems.filter(i => !i.date).map(item => (
                                    <DraggableCard 
                                        key={item.id} 
                                        item={item} 
                                        onDragStart={handleBulkDragStart} 
                                        onClick={(id) => { setEditingItem(item); setIsModalOpen(true); }} 
                                        onLongPress={(id) => handleLongPress(id, false)}
                                        onToggleSelect={(id) => handleToggleSelect(id, false)}
                                        isBulkSelecting={isBulkSelecting}
                                        isSelected={selectedItemIds.includes('I:' + item.id)}
                                        platforms={platforms} 
                                        statuses={statuses} 
                                        pillars={pillars}
                                        isTemplate={false}
                                    />
                                ))}

                                {allLibraryContent.length === 0 && <div className="text-center text-xs text-gray-400 py-10 border-2 border-dashed border-gray-100 dark:border-gray-800 rounded-2xl">Library Empty</div>}
                            </div>
                        </div>

                        <div className="p-4 border-t border-gray-100 dark:border-gray-800">
                             <div className="flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 p-2 rounded-2xl">
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-gray-500 hover:text-black dark:hover:text-white"><i className="ph ph-gear text-xl"></i></button>
                                <button onClick={toggleTheme} className="p-2 text-gray-500 hover:text-black dark:hover:text-white"><i className={`ph ${darkMode ? 'ph-sun' : 'ph-moon'} text-xl`}></i></button>
                                <button onClick={handleLogout} className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl"><i className="ph ph-sign-out text-xl"></i></button>
                             </div>
                        </div>
                    </div>

                    {/* Main Area */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden relative bg-[#F2F2F7] dark:bg-black">
                        <div className="h-20 bg-white/80 dark:bg-[#1C1C1E]/80 backdrop-blur-md sticky top-0 z-10 flex items-center justify-between px-8 border-b border-gray-200 dark:border-gray-800">
                            <div className="flex items-center gap-6">
                                {viewMode !== 'status' && viewMode !== 'list' && viewMode !== 'reports' && (
                                    <div className="flex items-center gap-4">
                                        <div className="flex bg-gray-100 dark:bg-gray-800 rounded-full p-1">
                                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white dark:hover:bg-gray-700 shadow-sm transition"><i className="ph ph-caret-left"></i></button>
                                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white dark:hover:bg-gray-700 shadow-sm transition"><i className="ph ph-caret-right"></i></button>
                                        </div>
                                        <h2 className="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                                    </div>
                                )}
                                {viewMode === 'status' && <h2 className="text-2xl font-bold tracking-tight">Status Board</h2>}
                                {viewMode === 'list' && <h2 className="text-2xl font-bold tracking-tight">Content List</h2>}
                                {viewMode === 'reports' && <h2 className="text-2xl font-bold tracking-tight">Reports & Analytics</h2>}
                            </div>

                             {/* Search Bar - Global */}
                             <div className="flex-1 max-w-md mx-6">
                                <div className="relative">
                                    <i className="ph ph-magnifying-glass absolute left-3 top-2.5 text-gray-400"></i>
                                    <input 
                                        type="text" 
                                        placeholder="Search content, platform..." 
                                        className="w-full bg-gray-100 dark:bg-gray-800 rounded-xl py-2 pl-10 pr-4 text-sm outline-none focus:ring-2 focus:ring-iosBlue/50 transition-all"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="flex bg-gray-200 dark:bg-gray-800 rounded-xl p-1">
                                    {[ 
                                        { id: 'month', icon: 'ph-calendar', label: 'Calendar' }, 
                                        { id: 'status', icon: 'ph-kanban', label: 'Status' },
                                        { id: 'list', icon: 'ph-list-dashes', label: 'List' },
                                        { id: 'reports', icon: 'ph-chart-bar', label: 'Reports' } 
                                    ].map(view => (
                                        <button key={view.id} onClick={() => { setViewMode(view.id); setIsBulkSelecting(false); setSelectedItemIds([]); }} className={`px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all ${viewMode === view.id ? 'bg-white dark:bg-gray-600 shadow text-black dark:text-white' : 'text-gray-500 hover:text-gray-900'}`}><i className={`ph ${view.icon}`}></i> {view.label}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => exportData('json')} className="w-10 h-10 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center text-iosBlue shadow-sm hover:scale-105 transition"><i className="ph ph-download-simple text-lg"></i></button>
                                </div>
                            </div>
                        </div>

                        {viewMode === 'month' && renderCalendarView()}
                        {viewMode === 'status' && renderStatusView()}
                        {viewMode === 'list' && renderListView()}
                        {viewMode === 'reports' && <ReportsView items={processedItems} pillars={pillars} topics={topics} />}
                    </div>

                    {isSettingsOpen && <SettingsModal onClose={() => setIsSettingsOpen(false)} platforms={platforms} setPlatforms={setPlatforms} statuses={statuses} setStatuses={setStatuses} pillars={pillars} setPillars={setPillars} topics={topics} setTopics={setTopics} defaultView={defaultView} setDefaultView={setDefaultView} />}
                    
                    {showReminder && (
                        <ReminderModal 
                            items={processedItems.filter(i => i.date === new Date().toISOString().split('T')[0])} 
                            onClose={() => setShowReminder(false)} 
                        />
                    )}

                    {/* Bulk Actions Toolbar */}
                    {isBulkSelecting && selectedItemIds.length > 0 && (
                        <div className="bulk-toolbar flex items-center gap-4">
                            <button onClick={() => { setIsBulkSelecting(false); setSelectedItemIds([]); }} className="bulk-toolbar-button text-white dark:text-black">
                                <i className="ph ph-x text-lg"></i> Cancel
                            </button>
                            <span className="text-sm font-semibold mx-2">{selectedItemIds.length} Selected</span>
                            <button onClick={() => setIsBulkEditModalOpen(true)} className="bulk-toolbar-button text-iosBlue dark:text-white hover:bg-blue-900/20 dark:hover:bg-gray-200">
                                <i className="ph ph-pencil-simple text-lg"></i> Group Edit
                            </button>
                            <button onClick={handleBulkDelete} className="bulk-toolbar-button text-red-400 dark:text-red-600 hover:bg-red-900/20 dark:hover:bg-red-100">
                                <i className="ph ph-trash text-lg"></i> Delete
                            </button>
                        </div>
                    )}
                    
                    {/* Bulk Edit Modal */}
                    {isBulkEditModalOpen && (
                        <BulkEditModal 
                            selectedItemIds={selectedItemIds}
                            items={items}
                            templates={templates}
                            platforms={platforms}
                            statuses={statuses}
                            pillars={pillars}
                            onUpdateBulk={handleUpdateBulk}
                            onClose={() => setIsBulkEditModalOpen(false)}
                        />
                    )}

                    {/* Content Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in-up h-[90vh] overflow-y-auto">
                                <ContentForm 
                                    initialData={editingItem || {}} 
                                    onSave={handleSaveItem} 
                                    onDelete={editingItem?.id ? () => handleDeleteItem(editingItem.id) : null} 
                                    onDuplicate={editingItem?.id ? () => handleDuplicateItem(editingItem) : null}
                                    platforms={platforms} 
                                    statuses={statuses} 
                                    pillars={pillars} 
                                    topics={topics} 
                                    onClose={() => setIsModalOpen(false)} 
                                />
                            </div>
                        </div>
                    )}
                    
                    {/* Template Modal (New) */}
                    {isTemplateModalOpen && (
                         <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in-up h-[90vh] overflow-y-auto">
                                <ContentForm 
                                    initialData={editingTemplate || {}} 
                                    isTemplate={true}
                                    saveTemplate={handleSaveTemplate} 
                                    deleteTemplate={editingTemplate?.id ? handleDeleteTemplate : null} 
                                    duplicateTemplate={editingTemplate?.id ? handleDuplicateTemplate : null}
                                    platforms={platforms} 
                                    statuses={statuses} 
                                    pillars={pillars} 
                                    topics={topics} 
                                    onClose={() => setIsTemplateModalClientopen(false)} 
                                />
                            </div>
                        </div>
                    )}

                    {/* New Event Modal */}
                    {isEventModalOpen && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up">
                                <EventForm initialData={editingEvent || {}} onSave={handleSaveEvent} onDelete={editingEvent?.id ? () => handleDeleteEvent(editingEvent.id) : null} onClose={() => { setIsEventModalOpen(false); setEditingEvent(null); }} />
                            </div>
                        </div>
                    )}

                    <CreateFab 
                        onOpenContent={() => { setEditingItem({ date: new Date().toISOString().split('T')[0], projectId: activeProjectId, platform: [], status: 'idea' }); setIsModalOpen(true); }}
                        onOpenEvent={() => { setEditingEvent({ date: new Date().toISOString().split('T')[0], color: 'bg-red-100 text-red-600' }); setIsEventModalOpen(true); }}
                    />

                    <NotebookOverlay items={items} onOpenItem={(item) => { setEditingItem(item); setIsModalOpen(true); }} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
